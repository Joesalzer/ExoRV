---
title: "NEID Solar Data -- RV calculations"
author: "Joe Salzer"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r}
## Data directory
wd_data = "/Users/josephsalzer/research/exostat/line_property_files/"
```

```{r}
# read data
final.df = read_csv("/Users/josephsalzer/research/exostat/completeLines.csv")
```

```{r}
final.df
```

# rv calculations

*rv calculations*

for a single line:
c = speed of light
$\lambda$ = central (rest) lambda value across time (this the average across time)
$\lambda_t$ = time-varying central lambda
$v_t$ = (dirty) radial velocity

$$
v_t = c \frac{\lambda_t - \lambda }{\lambda}
$$

fit_gauss_lambdac is our time-varying lambda (no others exist in our dataset)

lambdac_fit is our template lambda for gaussian fit
lambdac_fit_gh is our template lambda for hg fit

```{r}
# speed of light
c_light = 299792458
```

Radial velocity shift

For an Jupiter-like planet:
```{r}
v = 12

maxLambdaShift = (v/c_light)*unique(final.df$lambdac_fit)
summary(maxLambdaShift)

rm(maxLambdaShift)
```

For an Earth-like planet:
```{r}
v = .09

maxLambdaShift = (v/c_light)*unique(final.df$lambdac_fit)
summary(maxLambdaShift)

rm(maxLambdaShift)
```




```{r}


# index for a particular line
i = 200

# add in RV estimate
final.df %>%
  filter( line_order == unique(final.df$line_order)[i]  ) %>%
  mutate(rv_manual_gauss = c_light*(fit_gauss_lambdac-lambdac_fit)/lambdac_fit,
         rv_manual_gh = c_light*(fit_gauss_lambdac-lambdac_fit_gh)/lambdac_fit_gh) %>%
  dplyr::select(line_order, date, date_groups, lambdac_fit, lambdac_fit_gh, fit_gauss_lambdac, rv_template_0.5, rv_manual_gauss, rv_manual_gh)
```

```{r}
# add in RV estimate
final.df %>%
  #filter(  line_order == unique(final.df$line_order)[i]  ) %>%
  mutate(rv_manual_gauss = c_light*(fit_gauss_lambdac-lambdac_fit)/lambdac_fit,
         rv_manual_gh = c_light*(fit_gauss_lambdac-lambdac_fit_gh)/lambdac_fit_gh,
         change_rv_manual_gauss = rv_manual_gauss - mean(rv_manual_gauss),
         change_rv_manual_gh = rv_manual_gh - mean(rv_manual_gh),
         change_rv_template_0.5 = rv_template_0.5 - mean(rv_template_0.5)) %>%
  dplyr::select(line_order, date, date_groups, lambdac_fit, lambdac_fit_gh, fit_gauss_lambdac, rv_template_0.5, rv_manual_gauss, rv_manual_gh, change_rv_manual_gauss, change_rv_manual_gh, change_rv_template_0.5) %>%
  ggplot() +
  geom_point(mapping = aes(x = change_rv_manual_gauss, y = change_rv_template_0.5))
```

# compare old to new data

```{r}
## Data directory
wd_data = "/Users/josephsalzer/research/exostat/"

# get species info for each line
species.df = read_csv(str_c(wd_data,"neid_solar/","clean_line_info.csv")) %>%
  dplyr::select(lambda, species, excitation_energy) %>%
  mutate(lambda = factor( round(lambda,3) ),
         species = factor(species)) %>%
  unique()

# convert categorical vars to factors
model.df = tibble( read.csv(str_c(wd_data,"neid_solar/", "final_fits_6kmps.csv") ) ) %>%
  rename( wavelength = lambda ) %>%
  mutate( obs_date = factor(obs_date),
          lambda = factor(wavelength),
          order_idx = factor(order_idx),
          lam_order = factor( lam_order )
        )

# join final fits and species
model.df = model.df %>%
  left_join(species.df, by = "lambda")

rm(species.df)
```

```{r}
head(model.df)
```

```{r}
# list of lambdas in model.df
final_lams = ( model.df %>% group_by(lambda) %>% summarize(n. = n()) )$lambda
# list of lambda-orders in model.df
final_lams_orders = ( model.df %>% group_by(lam_order) %>% summarize(n. = n()) )$lam_order
# list of lambda-orders in model.df
final_days = ( model.df %>% group_by(obs_date) %>% summarize(n. = n()) )$obs_date
```

```{r}
# get model.df from modeling.Rmd, get a test of a few lines
set.seed(12345)
test.df = model.df %>% filter(lam_order %in% sample(final_lams_orders, size = 5))
rm(model.df)
```

```{r}
unique( test.df$lam_order )
```

```{r}
final.df
```

```{r}
# index of sampled lines to use
i = 1

test.df %>%
  filter(lam_order == unique( test.df$lam_order )[i] ) %>%
  mutate( obs_date = as.Date(obs_date) ) %>%
  dplyr::select(obs_date, rv_center) %>%
  inner_join(
    line.df %>%
      mutate(rv_center_new = rv_template_0.5 - mean(rv_template_0.5),
             obs_date = as.Date(date)) %>%
      dplyr::select(obs_date,rv_center_new)
    ) %>%
  ggplot() +
  geom_point(mapping = aes(x = rv_center, y = rv_center_new))
```


---
title: "NEID Solar Data -- Linear Modeling"
author: "Joe Salzer"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
#library(lme4)
#library(MASS)
#library(gridExtra)
#library(car)
#library(emmeans)
#library(glmnet)
#library(plm)
#library(sandwich)
#library(lmtest)
```

```{r}
## Data directory
wd_data = "/Users/josephsalzer/research/exostat/"
```

# Loading data

```{r}
# read data
final.df = read_csv("/Users/josephsalzer/research/exostat/completeLines.csv")
```

```{r}
colnames(final.df)
```

```{r}
# convert line order and date into factors
final.df = final.df %>%
  mutate(line_order = factor(line_order),
         date = as.Date(date))
```

```{r}
# list of lambdas in final.df
final.lams = ( final.df %>% group_by(lambdac_vald) %>% summarize(n. = n()) )$lambdac_vald
length(final.lams)
```
```{r}
# list of lamb-orders in model.df
final.line_order = ( final.df %>% group_by(line_order) %>% summarize(n. = n()) )$line_order
length(final.line_order)
```

```{r}
# list of lambda-orders in model.df
final.days = ( final.df %>% group_by(date) %>% summarize(n. = n()) )$date
length(final.days)
```

# Data summaries

```{r}
# check how many line-order pairs there are
final.df %>%
  group_by(lambdac_vald, order_idx) %>%
  count()
```
there are 910 line-order pairs, 345 observations per line-order pair

```{r}
# check how many line-order pairs there are
final.df %>%
  dplyr::select(date, date_groups) %>%
  unique() %>%
  count(date_groups)
```

before fire: 227 days
after fire: 118 days 

# base model

```{r}
one.way = aov(rv_template_0.5 ~ date, data = final.df)

summary(one.way)
```

```{r}
plot(one.way, 1)
```

```{r}
plot(one.way, 2)
```

```{r}
final.df
```

```{r}
# fit basic model
currentlm = lm(rv_template_0.5_change ~ factor(line_order) + factor(date), final.df )
```

```{r}
varMat = vcovHC(currentlm)
```





```{r}
# fit basic model (without days after fire)
currentlm = lm(rv_template_0.5_change ~ line_order + date, final.df %>% filter(date_groups == 1) )
```

```{r}
# get emmeans 
emmean.summary = summary( emmeans(currentlm, "date", nuisance = "line_order") )
```

```{r}
# dataframe of coefficients of currentlm 
# coef.df = tibble( coef = rownames(summary(currentlm )$coefficients),
#                   estimate = summary(currentlm )$coefficients[,1],
#                   se = summary(currentlm )$coefficients[,2],
#                   pval = summary(currentlm )$coefficients[,4] )
```



```{r}
# adj.r.squared
summary(currentlm)$adj.r.squared
# RSE
summary(currentlm)$sigma
# standard error of date effect (mean)
mean(emmean.summary$SE)
# percent of days that aren't statistically different than 0 (95%)
mean(
  (emmean.summary$emmean - qnorm(.975)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(.975)*emmean.summary$SE > 0)
)
# percent of days aren't statistically different than 0 (99%)
mean(
  (emmean.summary$emmean - qnorm(0.995)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(0.995)*emmean.summary$SE > 0)
)
```

```{r}
emmean.summary %>%
  ggplot() +
  geom_point(aes(x = as.Date(date), y = emmean), color = "black") +
  geom_errorbar(aes(x = as.Date(date), ymin = emmean - 1.96*SE, ymax = emmean + 1.96*SE), color = "black") +
  geom_hline(yintercept = 0, color = "red")
```

```{r}
rm(currentlm, coef.df, emmean.summary)
```

# middle model

```{r}
changeVars = c("fit_gauss_a_change", "fit_gauss_b_change", "fit_gauss_depth_change", "fit_gauss_sigmasq_change", "rv_template_0.5_change", "hg_coeff_0_change", "hg_coeff_1_change", "hg_coeff_2_change", "hg_coeff_3_change", "hg_coeff_4_change", "hg_coeff_5_change", "hg_coeff_6_change", "hg_coeff_7_change", "hg_coeff_8_change", "hg_coeff_9_change", "hg_coeff_10_change")
```

scaled, change vars
```{r}
current.df = final.df %>%
  mutate(date_groups = factor(date_groups)) %>%
  dplyr::select( rv_template_0.5_change, date, date_groups, line_order, all_of(changeVars) ) %>%
  mutate_at(all_of(changeVars), scale, center = F) 
current.df
```


```{r}
# the current linear model to be worked on
currentlm = lm(rv_template_0.5_change ~ date + line_order + fit_gauss_depth_change*fit_gauss_sigmasq_change, current.df)
```

```{r}
# get emmeans 
emmean.summary = summary( emmeans(currentlm, "date", nuisance = c("line_order") ) )
```

```{r}
head(emmean.summary)
```


```{r}
# dataframe of coefficients of currentlm 
coef.df = tibble( coef = rownames(summary(currentlm )$coefficients),
                  estimate = summary(currentlm )$coefficients[,1],
                  se = summary(currentlm )$coefficients[,2],
                  pval = summary(currentlm )$coefficients[,4] )
```


```{r}
tail(coef.df, 3)
```


```{r}
# adj.r.squared
summary(currentlm)$adj.r.squared
# RSE
summary(currentlm)$sigma
# standard error of date effect (mean)
mean(emmean.summary$SE)
# percent of days that aren't statistically different than 0 (95%)
mean(
  (emmean.summary$emmean - qnorm(.975)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(.975)*emmean.summary$SE > 0)
)
# percent of days aren't statistically different than 0 (99%)
mean(
  (emmean.summary$emmean - qnorm(0.995)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(0.995)*emmean.summary$SE > 0)
)
```

```{r}
emmean.summary %>%
  ggplot() +
  geom_point(aes(x = as.Date(date), y = emmean), color = "black") +
  geom_errorbar(aes(x = as.Date(date), ymin = emmean - 1.96*SE, ymax = emmean + 1.96*SE), color = "black") +
  geom_hline(yintercept = 0, color = "red")
```


# big model

```{r}
centerVars = c("fit_gauss_a_center", "fit_gauss_b_center", "fit_gauss_depth_center", 
             "fit_gauss_sigmasq_center", "hg_coeff_0_center", "hg_coeff_1_center", 
             "hg_coeff_2_center", "hg_coeff_3_center", "hg_coeff_4_center", 
             "hg_coeff_5_center", "hg_coeff_6_center", "hg_coeff_7_center", 
             "hg_coeff_8_center", "hg_coeff_9_center", "hg_coeff_10_center")
```

```{r}
current.df = final.df %>%
  #filter(date_groups == 1) %>%
  mutate(date = factor(date)) %>%
  dplyr::select( rv_template_0.5_change, date, line_order, all_of(centerVars) ) %>%
  mutate_at(centerVars, scale, center = F)
current.df
```

```{r}
# the current linear model to be worked on
currentlm = lm(rv_template_0.5_change ~ date + line_order + fit_gauss_a_center + fit_gauss_b_center + fit_gauss_depth_center + fit_gauss_sigmasq_center + hg_coeff_0_center + hg_coeff_2_center + hg_coeff_3_center + hg_coeff_4_center + hg_coeff_5_center + hg_coeff_6_center + hg_coeff_7_center, current.df)
```

```{r}
# get emmeans 
emmean.summary = summary( emmeans(currentlm, "date", nuisance = c("line_order") ) )
```

```{r}
# get emmeans 
emmean.summary = summary( emmeans(currentlm, "line_order", nuisance = c("date") ) )
```

```{r}
head(emmean.summary)
```


```{r}
# dataframe of coefficients of currentlm 
coef.df = tibble( coef = rownames(summary(currentlm )$coefficients),
                  estimate = summary(currentlm )$coefficients[,1],
                  se = summary(currentlm )$coefficients[,2],
                  pval = summary(currentlm )$coefficients[,4] )
```


```{r}
tail(coef.df, 11)
```

```{r}
# adj.r.squared
summary(currentlm)$adj.r.squared
# RSE
summary(currentlm)$sigma
# standard error of date effect (mean)
mean(emmean.summary$SE)
# percent of days that aren't statistically different than 0 (95%)
mean(
  (emmean.summary$emmean - qnorm(.975)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(.975)*emmean.summary$SE > 0)
)
# percent of days aren't statistically different than 0 (99%)
mean(
  (emmean.summary$emmean - qnorm(0.995)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(0.995)*emmean.summary$SE > 0)
)
```

### 

Estimates using before fire data (response: rv_template_0.5_change):

fit_gauss_a_center	3.751978	0.19910998	3.858122e-79	
fit_gauss_b_center	-14.269977	0.05071279	0.000000e+00	
fit_gauss_depth_center	-14.636122	0.21779185	0.000000e+00	
fit_gauss_sigmasq_center	-4.036285	0.06114630	0.000000e+00	
hg_coeff_0_center	-9.406543	0.31679126	2.420095e-193	
hg_coeff_2_center	3.578208	0.32630237	5.673138e-28	
hg_coeff_3_center	60.523228	0.19961069	0.000000e+00	
hg_coeff_4_center	4.180721	0.36512122	2.395588e-30	
hg_coeff_5_center	45.910383	0.32591723	0.000000e+00	
hg_coeff_6_center	2.129525	0.17641119	1.535850e-33	
hg_coeff_7_center	13.345212	0.17744784	0.000000e+00

[1] 0.7317755
[1] 19.5463
[1] 0.6480199
[1] 0.7885463
[1] 0.9251101

###

Estimates using all data (response: rv_template_0.5):

fit_gauss_a_center	6.9427601	0.16242787	0.000000e+00	
fit_gauss_b_center	-13.9694917	0.04221402	0.000000e+00	
fit_gauss_depth_center	-15.5420949	0.18283002	0.000000e+00	
fit_gauss_sigmasq_center	-4.0693039	0.05139281	0.000000e+00	
hg_coeff_0_center	-14.1802439	0.26015398	0.000000e+00	
hg_coeff_2_center	0.6015480	0.27250806	2.728334e-02	
hg_coeff_3_center	55.8008071	0.16699927	0.000000e+00	
hg_coeff_4_center	0.7564626	0.30266825	1.244395e-02	
hg_coeff_5_center	42.9824939	0.27649240	0.000000e+00	
hg_coeff_6_center	0.5936730	0.14536083	4.425269e-05
hg_coeff_7_center	12.8734725	0.15064054	0.000000e+00

[1] 0.7419272
[1] 20.72138
[1] 0.6869755
[1] 0.3942029
[1] 0.5652174

before fire

```{r}
emmean.summary %>%
  ggplot() +
  geom_point(aes(x = as.Date(date), y = emmean), color = "black") +
  geom_errorbar(aes(x = as.Date(date), ymin = emmean - 1.96*SE, ymax = emmean + 1.96*SE), color = "black") +
  geom_hline(yintercept = 0, color = "red")
```
all data

```{r}
emmean.summary %>%
  ggplot() +
  geom_point(aes(x = as.Date(date), y = emmean), color = "black") +
  geom_errorbar(aes(x = as.Date(date), ymin = emmean - 1.96*SE, ymax = emmean + 1.96*SE), color = "black") +
  geom_hline(yintercept = 0, color = "red")
```


```{r}
rm(currentlm, coef.df, emmean.summary)
```

# sinusodial model

```{r}
centerVars = c("fit_gauss_a_center", "fit_gauss_b_center", "fit_gauss_depth_center", 
             "fit_gauss_sigmasq_center", "hg_coeff_0_center", "hg_coeff_1_center", 
             "hg_coeff_2_center", "hg_coeff_3_center", "hg_coeff_4_center", 
             "hg_coeff_5_center", "hg_coeff_6_center", "hg_coeff_7_center", 
             "hg_coeff_8_center", "hg_coeff_9_center", "hg_coeff_10_center")
```

scaled, center vars
```{r}
current.df = final.df %>%
  filter(date_groups == 1) %>%
  mutate(date = as.numeric(date)) %>%
  dplyr::select( rv_template_0.5_change, date, line_order, all_of(centerVars) ) %>%
  mutate_at(centerVars, scale, center = F) %>%
  mutate( cos_fit = cos(2*pi*date/366),
          sin_fit = sin(2*pi*date/366))
current.df
```

```{r}
# the current linear model to be worked on
currentlm = lm(rv_template_0.5_change ~ line_order + sin_fit + fit_gauss_a_center + fit_gauss_b_center + fit_gauss_depth_center + fit_gauss_sigmasq_center + hg_coeff_0_center + hg_coeff_2_center + hg_coeff_3_center + hg_coeff_4_center + hg_coeff_5_center + hg_coeff_6_center + hg_coeff_7_center, current.df)
```

```{r}
# dataframe of coefficients of currentlm 
coef.df = tibble( coef = rownames(summary(currentlm )$coefficients),
                  estimate = summary(currentlm )$coefficients[,1],
                  se = summary(currentlm )$coefficients[,2],
                  pval = summary(currentlm )$coefficients[,4] )
```

```{r}
tail(coef.df, 13)
```

```{r}
current.df %>%
  dplyr::select(date, cos_fit, sin_fit) %>%
  unique() %>%
  mutate(clean_rv = -0.01542862 * sin_fit,
         lb = (-0.01542862 - 0.06148188) * sin_fit,
         ub = (-0.01542862 + 0.06148188) * sin_fit) %>% 
  ggplot() +
  geom_point(mapping = aes(x = date, y = clean_rv)) +
  geom_errorbar(aes(x = date, ymin = lb, ymax = ub), color = "black", linewidth = .25)
```

```{r}
current.df %>%
  dplyr::select(date, cos_fit, sin_fit) %>%
  unique() %>%
  mutate(clean_rv = 0.4980183 * cos_fit + 0.0595899 * sin_fit,
         lb = (0.4980183 - 1.96*0.07469450) * cos_fit + (0.0595899 - 1.96*0.06249656 ) * sin_fit,
         ub = (0.4980183 + 1.96*0.07469450) * cos_fit + (0.0595899 + 1.96*0.06249656 ) * sin_fit) %>% 
  ggplot() +
  geom_point(mapping = aes(x = date, y = clean_rv)) +
  geom_errorbar(aes(x = date, ymin = lb, ymax = ub), color = "black", linewidth = .25)
```

```{r}
current.df %>%
  dplyr::select(date, sin_fit) %>%
  unique() %>%
  mutate(clean_rv = -0.01542862 * sin_fit) %>% 
  ggplot() +
  geom_point(mapping = aes(x = date, y = clean_rv))
```

```{r}
# adj.r.squared
summary(currentlm)$adj.r.squared
# RSE
summary(currentlm)$sigma
```


# with planet signal

## 2FE model

```{r}
centerVars = c("fit_gauss_a_center", "fit_gauss_b_center", "fit_gauss_depth_center", 
             "fit_gauss_sigmasq_center", "hg_coeff_0_center", "hg_coeff_1_center", 
             "hg_coeff_2_center", "hg_coeff_3_center", "hg_coeff_4_center", 
             "hg_coeff_5_center", "hg_coeff_6_center", "hg_coeff_7_center", 
             "hg_coeff_8_center", "hg_coeff_9_center", "hg_coeff_10_center")
```

```{r}
# amplitude
amp = 2
# frequency
freq = 2*pi/366
```

```{r}
changeFun = function(x) ( x - x[1] )

current.df = final.df %>%
  filter(date_groups == 1) %>%
  mutate(date = as.Date(date)) %>%
  dplyr::select( rv_template_0.5, date, line_order, all_of(centerVars) ) %>%
  mutate_at(centerVars, scale, center = F) %>%
  group_by(date) %>%
  mutate(date_num  = as.numeric(date),
         pert_val = amp*sin(freq*date_num) ) %>%
  ungroup() %>%
  mutate(rv_pert = rv_template_0.5 + pert_val) %>%
  group_by(line_order) %>%
  mutate(rv_pert_change = changeFun(rv_pert),
         pert_change = changeFun(pert_val) ) %>%
  ungroup() %>%
  mutate(date = factor(date))
current.df
```

```{r}
current.df %>%
  group_by(date) %>%
  summarize(mean_RV = mean(rv_pert_change),
            pert = mean(pert_change)) %>%
  ungroup() %>%
  ggplot() +
  geom_point(mapping = aes(x = as.Date(date), y = mean_RV)) +
  geom_point(mapping = aes(x = as.Date(date), y = pert), color = "red")
```

```{r}
# the current linear model to be worked on
currentlm = lm(rv_pert_change ~ date + line_order + fit_gauss_a_center + fit_gauss_b_center + fit_gauss_depth_center + fit_gauss_sigmasq_center + hg_coeff_0_center + hg_coeff_2_center + hg_coeff_3_center + hg_coeff_4_center + hg_coeff_5_center + hg_coeff_6_center + hg_coeff_7_center, current.df)
```

```{r}
# get emmeans 
emmean.summary = summary( emmeans(currentlm, "date", nuisance = c("line_order") ) )
```

```{r}
head(emmean.summary)
```


```{r}
# dataframe of coefficients of currentlm 
coef.df = tibble( coef = rownames(summary(currentlm )$coefficients),
                  estimate = summary(currentlm )$coefficients[,1],
                  se = summary(currentlm )$coefficients[,2],
                  pval = summary(currentlm )$coefficients[,4] )
```



```{r}
current.df %>%
  dplyr::select(date, pert_change) %>%
  unique() %>%
  inner_join(emmean.summary, by = "date") %>%
  ggplot() +
  geom_point(aes(x = as.Date(date), y = emmean), color = "black") +
  geom_errorbar(aes(x = as.Date(date), ymin = emmean - 1.96*SE, ymax = emmean + 1.96*SE), color = "black") +
  geom_hline(yintercept = 0, color = "red") +
  geom_point(mapping = aes(x = as.Date(date), y = pert_change), color = "red")
  
```

## sin model

```{r}
centerVars = c("fit_gauss_a_center", "fit_gauss_b_center", "fit_gauss_depth_center", 
             "fit_gauss_sigmasq_center", "hg_coeff_0_center", "hg_coeff_1_center", 
             "hg_coeff_2_center", "hg_coeff_3_center", "hg_coeff_4_center", 
             "hg_coeff_5_center", "hg_coeff_6_center", "hg_coeff_7_center", 
             "hg_coeff_8_center", "hg_coeff_9_center", "hg_coeff_10_center")
```

```{r}
# amplitude
amp = 2
# frequency
freq = 2*pi/366
```


```{r}
changeFun = function(x) ( x - x[1] )

current.df = final.df %>%
  filter(date_groups == 1) %>%
  mutate(date = as.numeric(date)) %>%
  dplyr::select( rv_template_0.5, date, line_order, all_of(centerVars) ) %>%
  mutate_at(centerVars, scale, center = F) %>%
  mutate(sin_fit = sin(2*pi*date/366)) %>%
  group_by(date) %>%
  mutate(pert_val = amp*sin(freq*date) ) %>%
  ungroup() %>%
  mutate(rv_pert = rv_template_0.5 + pert_val) %>%
  group_by(line_order) %>%
  mutate(rv_pert_change = changeFun(rv_pert),
         pert_change = changeFun(pert_val) ) %>%
  ungroup()
current.df
```


```{r}
current.df %>%
  group_by(date) %>%
  summarize(mean_RV = mean(rv_pert_change),
            pert = mean(pert_change)) %>%
  ungroup() %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = mean_RV)) +
  geom_point(mapping = aes(x = date, y = pert), color = "red")
```


```{r}
# the current linear model to be worked on
currentlm = lm(rv_pert_change ~ line_order + sin_fit + fit_gauss_a_center + fit_gauss_b_center + fit_gauss_depth_center + fit_gauss_sigmasq_center + hg_coeff_0_center + hg_coeff_2_center + hg_coeff_3_center + hg_coeff_4_center + hg_coeff_5_center + hg_coeff_6_center + hg_coeff_7_center, current.df)
```

```{r}
# dataframe of coefficients of currentlm 
coef.df = tibble( coef = rownames(summary(currentlm )$coefficients),
                  estimate = summary(currentlm )$coefficients[,1],
                  se = summary(currentlm )$coefficients[,2],
                  pval = summary(currentlm )$coefficients[,4] )
```

```{r}
tail(coef.df, 12)
```


```{r}
current.df %>%
  dplyr::select(date, sin_fit, pert_val, pert_change) %>%
  unique() %>%
  mutate(clean_rv = 1.984571 * sin_fit,
         lb = (1.984571 - 1.96 * 0.06148188) * sin_fit,
         ub = (1.984571 + 1.96 * 0.06148188) * sin_fit) %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = clean_rv)) +
  geom_point(mapping = aes(x = date, y = pert_val), color = "red") +
  geom_errorbar(aes(x = date, ymin = lb, ymax = ub), color = "black", linewidth = .25)
```


# AR modeling

```{r}
# amplitude
amp = 2
# frequency
freq = 2*pi/366
```

```{r}
toy.df = data.frame(
  day = seq(1,800, by = 3)
)
toy.df$response = amp*sin(freq*toy.df$day)
```

```{r}
toy.df = toy.df %>%
  mutate(responseLag1 = lag(response)) %>%
  filter(!(day %in% c(1)))
```

```{r}
toy.df = toy.df %>%
  mutate(responseLag1 = lag(response),
         responseLag2 = lag(response, 2)) %>%
  filter(!(day %in% c(1,4)))
```

```{r}
toy.df
```

```{r}
toy.df %>%
  ggplot() +
  geom_point(mapping = aes(x = day, y = response))
```

```{r}
currentlm = lm(response ~ responseLag1, toy.df)
summary(currentlm)
```

```{r}
currentlm = lm(response ~ responseLag1 + responseLag2, toy.df)
summary(currentlm)
```



```{r}
toy.df %>%
  ggplot() +
  geom_point(mapping = aes(x = day, y = response)) +
  geom_line(mapping = aes(x = day, y = currentlm$fitted.values), color = "red")
```


---
title: "NEID Solar Data -- loading raw spectra"
author: "Joe Salzer"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(MASS)
library(rhdf5)
source("readSpectra.R")
```

```{r}
## Data directory
wd_data = "/Users/josephsalzer/research/exostat/raw_spectrum_files/"
```

# Loading data

## gh changes

```{r}
template_deriv_onto_gh = H5Fopen("project_template_deriv_onto_gh.h5")
```

```{r}
template_deriv_onto_gh$gh_vs_mps_coeffs
```

```{r}
rm(template_deriv_onto_gh)
```


# file lists

```{r}
# list of files in raw_spectrum_files
file_list = list.files("raw_spectrum_files")
```

```{r}
# list of solar spectrum files
solarspectrum_list = file_list[!is.na( str_extract(file_list,"solar_spectrum") )]
# get dates for solar spectrum
all_dates = str_sub( str_split_fixed(solarspectrum_list,"_",n=3)[,3], end = -4 )
```

```{r}
# list of line files
line_list = file_list[!is.na( str_extract(file_list,"line") )]
# get line-orders 
all_lineorders = str_sub( str_split_fixed(line_list,"_",n=2)[,2], end = -4 )
```

# read solar spectra and single line


```{r}
length(solarspectrum_list)
length(line_list)
```

```{r}
# example solar spectrum

solar_spectrum.df = loadSolarFile(solarspectrum_list[100])
single_line.df = loadLineFile( line_list[40] )
```

###solar_spectrum

```{r}
summary( solar_spectrum.df )
```


### single_line

```{r}
summary(single_line.df)
```

# Figures

## flux (or flux norm) by lambda for a given order

```{r}
rbind(loadSolarFile(solarspectrum_list[100]), loadSolarFile(solarspectrum_list[101])) %>%
  filter(order == single_line.df$order_idx[1]) %>%
  group_by(pixel) %>%
  summarise(sdLambda = sd(lambda)) 
```

```{r}
rbind(loadSolarFile(solarspectrum_list[100]), loadSolarFile(solarspectrum_list[101])) %>%
  filter(order == single_line.df$order_idx[1]) %>%
  ggplot() +
  geom_line(mapping = aes(x = pixel, y = lambda, color = date)) +
  xlim(5000, 7500) +
  ylim(4615,4640)
```


```{r}
loadSolarFile(solarspectrum_list[100]) %>%
  filter(order == single_line.df$order_idx[1]) %>%
  ggplot() +
  geom_point(mapping = aes(x = pixel, y = lambda))
```

```{r}
loadSolarFile(solarspectrum_list[101]) %>%
  filter(order == single_line.df$order_idx[1]) %>%
  ggplot() +
  geom_line(mapping = aes(x = pixel, y = lambda))
```

```{r}
solar_spectrum.df %>%
  filter(order == single_line.df$order_idx[1]) %>%
  ggplot(mapping = aes(x = lambda, y = flux)) +
  #ggplot(mapping = aes(x = pixel, y = flux)) +
  geom_point() +
  ggtitle(str_c("order ",single_line.df$order_idx[1]))
```


## line file on the spectrum

```{r}
# lower and upper pixel
pixel_lower = min(single_line.df$pixel)
pixel_upper = max(single_line.df$pixel)
```

lines on lambdac_fit and lambdac_vald

```{r}
single_line.df %>%
  filter(date == all_dates[110]) %>%
  ggplot() +
  geom_point(mapping = aes(x=lambda,y=flux_norm)) +
  geom_vline(xintercept = single_line.df$lambdac_fit[1], color = "orange") +
  geom_vline(xintercept = single_line.df$lambdac_vald[1], color = "purple")
```
```{r}
single_line.df %>%
  #filter(date == "2022-09-11") %>%
  ggplot() +
  geom_point(mapping = aes(x=pixel,y=flux_norm))
```

each pixel is roughly associated with each lambda
```{r}
single_line.df %>%
  #filter(date == "2022-09-11") %>%
  ggplot() +
  geom_point(mapping = aes(x=pixel,y=lambda))
```



```{r}
solar_spectrum.df %>%
  filter(order == single_line.df$order_idx[1],
         pixel >= pixel_lower - 50,
         pixel <= pixel_upper + 50) %>%
  ggplot(mapping = aes(x = lambda, y = flux_norm)) +
  geom_vline(xintercept = (single_line.df %>% filter(date == "2021-01-01", pixel == pixel_lower))$lambda) +
  geom_vline(xintercept = (single_line.df %>% filter(date == "2021-01-01", pixel == pixel_upper))$lambda) +
  geom_point()
```









# network hypothesis, single line



```{r}
# include change in flux norm and scale flux norm as columns:
single_line.df = single_line.df %>%
  group_by(pixel) %>%
  mutate(change_flux_norm = flux_norm - mean(flux_norm),
         scaledflux_byline = change_flux_norm/sd(flux_norm)) %>%
  ungroup() %>%
  mutate(scaledflux_total = change_flux_norm/sd(flux_norm) )
```

change_flux_norm: flux_norm - mean(flux_norm) by pixel
scaledflux_byline: change_flux_norm/sd(flux_norm) by pixel
scaledflux_total: change_flux_norm/sd(flux_norm) for every line

```{r}
single_line.df%>%
  filter(pixel <= pixel_upper-35) %>%
  filter(pixel >= pixel_lower+35) %>%
  #filter(pixel <= pixel_upper-40) %>%
  #filter(pixel >= pixel_lower+40) %>%
  mutate(date = as.Date(date)) %>%
  ggplot(mapping = aes(x = date, y = flux_norm, color = pixel, group = pixel)) +
  geom_point()
```


```{r}
single_line.df%>%
  filter(pixel <= pixel_upper-35) %>%
  filter(pixel >= pixel_lower+35) %>%
  #filter(pixel <= pixel_upper-40) %>%
  #filter(pixel >= pixel_lower+40) %>%
  mutate(date = as.Date(date)) %>%
  ggplot(mapping = aes(x = date, y = change_flux_norm, color = pixel, group = pixel)) +
  geom_point()
```


```{r}
single_line.df%>%
  filter(pixel <= pixel_upper-35) %>%
  filter(pixel >= pixel_lower+35) %>%
  #filter(pixel <= pixel_upper-40) %>%
  #filter(pixel >= pixel_lower+40) %>%
  mutate(date = as.Date(date)) %>%
  ggplot(mapping = aes(x = date, y = scaledflux_byline, color = pixel, group = pixel)) +
  geom_point()
```


```{r}
single_line.df%>%
  filter(pixel <= pixel_upper-35) %>%
  filter(pixel >= pixel_lower+35) %>%
  #filter(pixel <= pixel_upper-40) %>%
  #filter(pixel >= pixel_lower+40) %>%
  mutate(date = as.Date(date)) %>%
  ggplot(mapping = aes(x = date, y = scaledflux_total, color = pixel, group = pixel)) +
  geom_point()
```

```{r}
single_line.df%>%
  filter(pixel <= pixel_upper-40) %>%
  filter(pixel >= pixel_lower+40) %>%
  #filter(pixel <= pixel_upper-40) %>%
  #filter(pixel >= pixel_lower+40) %>%
  mutate(date = as.Date(date)) %>%
  ggplot(mapping = aes(x = scaledflux_byline, y = scaledflux_total, color = pixel, group = pixel)) +
  geom_point()
```

```{r}
single_line.df%>%
  filter(pixel <= pixel_upper-35) %>%
  filter(pixel >= pixel_lower+35)
```


small correlation mat
```{r}
single_line.df%>%
  filter(pixel <= pixel_upper-35) %>%
  filter(pixel >= pixel_lower+35) %>%
  #filter(pixel <= pixel_upper-40) %>%
  #filter(pixel >= pixel_lower+40) %>%
  mutate(date = as.Date(date)) %>%
  dplyr::select(date, pixel, flux_norm) %>%
  pivot_wider(names_from = pixel, values_from = flux_norm, names_prefix = "pixel") %>%
  dplyr::select(!date) %>%
  cor()
  
```



```{r}
single_line.df %>%
  #filter(date < all_dates[150] ) %>%
  filter(pixel <= pixel_upper-35) %>%
  filter(pixel >= pixel_lower+35) %>%
  ggplot() +
  geom_point(mapping = aes(x=lambda,y=flux_norm, color=pixel)) +
  geom_vline(xintercept = single_line.df$lambdac_vald[1], color = "purple")
```

```{r}
single_line.df %>%
  #filter(date < all_dates[150] ) %>%
  filter(pixel <= pixel_upper-35) %>%
  filter(pixel >= pixel_lower+35) %>%
  ggplot() +
  geom_point(mapping = aes(x=lambda,y=flux_norm, color=date)) +
  geom_vline(xintercept = single_line.df$lambdac_vald[1], color = "purple")
```


```{r}
single_line.df %>%
  #filter(date == "2022-09-11") %>%
  ggplot() +
  geom_point(mapping = aes(x=pixel,y=flux_norm)) +
  geom_vline(xintercept = 1668, color = "purple") +
  geom_vline(xintercept = 1683, color = "orange")
```
```{r}
single_line.df%>%
  filter(pixel <= 1683) %>%
  filter(pixel >= 1668) %>%
  mutate(date = as.Date(date)) %>%
  ggplot(mapping = aes(x = lambda, y = change_flux_norm, color = date)) +
  geom_point()
```

```{r}
single_line.df%>%
  filter(pixel <= 1683) %>%
  filter(pixel >= 1668) %>%
  #filter(pixel <= pixel_upper-40) %>%
  #filter(pixel >= pixel_lower+40) %>%
  mutate(date = as.Date(date)) %>%
  ggplot(mapping = aes(x = date, y = change_flux_norm, color = pixel, group = pixel)) +
  geom_point()
```


---
title: "NEID Solar Data -- EDA"
author: "Joe Salzer"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#library(FactoMineR)
#library(GGally)
source("readSpectra.R")
# autocorrelation
#library(collapse)
```

```{r}
## Data directory
wd_data = "/Users/josephsalzer/research/exostat/line_property_files/"
```

# Loading data

```{r}
# read data
final_df = read_csv("/Users/josephsalzer/research/exostat/completeLines.csv")
```

```{r}
# list of lambdas in final_df
wavelengthIDs = ( final_df %>% group_by(lambdac_vald) %>% summarize(n. = n()) )$lambdac_vald
length(wavelengthIDs)
```

```{r}
# list of lambda-orders in final_df
lineIDs = ( final_df %>% group_by(line_order) %>% summarize(n. = n()) )$line_order
length(lineIDs)
```

```{r}
# list of lambda-orders in final_df
dayIDs = ( final_df %>% group_by(date) %>% summarize(n. = n()) )$date
length(dayIDs)
```

# Data summaries

```{r}
# check how many line-order pairs there are
final_df %>%
  group_by(lambdac_vald, order_idx) %>%
  count()
```
there are 910 line-order pairs, 345 observations per line-order pair


*rv summary*
```{r}
summary(final_df$rv_template_0.5)
```

*change rv summary*
```{r}
final_df %>%
  group_by(line_order) %>%
  mutate(rv_template_0.5_change = changeFun(rv_template_0.5)) %>%
  ungroup() %>%
  filter(date != "2021-01-01") %>%
  pull(rv_template_0.5_change) %>%
  summary()
```

*rv wrt fit_gauss_lambdac*
```{r}
final_df %>%
  group_by(line_order) %>%
  mutate(lambda_change = changeFun(fit_gauss_lambdac),
         rv_manual = 299792458*lambda_change/fit_gauss_lambdac[1]) %>%
  ungroup() %>%
  select(date, line_order, fit_gauss_lambdac, lambda_change, rv_manual) %>%
  filter(date != "2021-01-01") %>%
  pull(rv_manual) %>%
  summary()
```




# manual rv v rv_template

```{r}
final_df
```

```{r}
final_df %>%
  group_by(line_order) %>%
  mutate(lambda_change = changeFun(fit_gauss_lambdac),
         rv_manual = 299792458*lambda_change/fit_gauss_lambdac[1]) %>%
  ungroup() %>%
  filter(date != "2021-01-01") %>%
  ggplot() +
  geom_point( mapping = aes(x = rv_manual, y = rv_template_0.5), size = .5 )
```


# sigma values

```{r}
final_df %>%
  select( line_order, date, starts_with("sigma"),  starts_with("fit_gauss_sigma_")) %>%
  filter(date == "2021-01-01")
```



```{r}
final_df %>%
  group_by(line_order) %>%
  mutate(meanSNR = mean(mean_snr_pixel),
         meanRV = mean(rv_template_0.5),
         sdRV = sd(rv_template_0.5)) %>%
  ungroup() %>%
  filter(lambdac_vald < 9000,
         sdRV < 20) %>%
  filter( !(order_idx %in% c(56,57,58)) ) %>%
  ggplot() +
  geom_point(mapping = aes(x = meanSNR, y = abs(rv_template_0.5 - meanRV) , color = order_idx), size = .5)
```

```{r}
final_df %>%
  group_by(line_order) %>%
  mutate(meanSNR = mean(mean_snr_pixel),
         sdRV = sd(rv_template_0.5) ) %>%
  ungroup() %>%
  #filter(lambdac_vald < 9000) %>%
  ggplot() +
  geom_point(mapping = aes(x = mean_snr_pixel, y = sdRV, color = lambdac_vald), alpha = .5, size = .5)
```

```{r}
final_df %>%
  mutate(pixelLocation = (pixel_extracted_hi + pixel_extracted_lo)/2 ) %>%
  ggplot() +
  geom_point(mapping = aes(x = pixelLocation, y = mean_snr_pixel, color = order_idx), size = .2)
```
```{r}
final_df %>%
  mutate(pixelLocation = (pixel_extracted_hi + pixel_extracted_lo)/2 ) %>%
  group_by(line_order) %>%
  summarize(sdRV = sd(rv_template_0.5),
            pixel = mean(pixelLocation)) %>%
  ggplot() +
  geom_point(mapping = aes(x = pixel, y = sdRV), size = .2)
```

```{r}
final_df %>%
  mutate(pixelLocation = (pixel_extracted_hi + pixel_extracted_lo)/2 ) %>%
  group_by(line_order) %>%
  summarize(meanRV = mean(rv_template_0.5),
            sdRV = sd(rv_template_0.5),
            pixel = mean(pixelLocation)) %>%
  ggplot() +
  geom_point(mapping = aes(x = meanRV, y = sdRV), size = .2) +
  ylim(0,40) +
  xlim(-20,20)
```

```{r}
final_df %>%
  mutate(pixelLocation = (pixel_extracted_hi + pixel_extracted_lo)/2 ) %>%
  group_by(line_order) %>%
  summarize(meanRV = mean(rv_template_0.5),
            pixel = mean(pixelLocation)) %>%
  ggplot() +
  geom_point(mapping = aes(x = pixel, y = meanRV), size = .2) +
  ylim(-100,100)
```


```{r}
final_df %>%
  filter(mean_snr_pixel > 300) %>%
  ggplot() +
  geom_point(mapping = aes(x = mean_snr_pixel, y = rv_template_0.5, color = lambdac_vald))
```

```{r}
final_df %>%
  ggplot() +
  geom_point(mapping = aes(x = fit_gauss_sigma_depth, y = rv_template_0.5, color = lambdac_vald))
```

```{r}
final_df %>%
  filter(lambdac_vald < 9000) %>%
  ggplot() +
  geom_point(mapping = aes(x = sigma_rv_template_0.5, y = rv_template_0.5, color = lambdac_vald))
```


# Autocorrelation

```{r}
auto.df = final_df %>%
  filter(date_groups == 1) %>%
  dplyr::select(line_order,date,rv_template_0.5) %>%
  filter(line_order == "4536.04649_39" )

auto.df

auto.df %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = rv_template_0.5))
```


```{r}
acf(auto.df$rv_template_0.5)
```

```{r}
rm(auto.df)
```

## panel autocorrelation

```{r}
auto.df = final_df %>%
  dplyr::select(line_order,date,rv_template_0.5)
auto.df
```

```{r}
psacf(auto.df$rv_template_0.5, auto.df$line_order, auto.df$date) 
```


# weighted PCA

different weights
```{r}
summary( final_df %>% select(fit_gauss_sigma_depth, sigma_hg_coeff_1, mean_snr_pixel) )
```

```{r}
final_df %>%
  select(fit_gauss_sigma_depth, sigma_hg_coeff_1, mean_snr_pixel) %>%
  ggpairs()
```

```{r}
final_df %>%
  mutate(weight_depth = 1/fit_gauss_sigma_depth^2,
         weight_hg1 = 1/sigma_hg_coeff_1^2,
         weight_snr = mean_snr_pixel^2,
         wavelength_round = factor(round(lambdac_vald, -3)) ) %>%
  select(weight_depth, weight_hg1, weight_snr, wavelength_round) %>%
  ggpairs(columns = 1:3,mapping = aes(color = wavelength_round), size = .1, alpha = .3)
```

```{r}
odd_gh = final_df[ str_c( "hg_coeff_", as.character( seq(1,10,2) ) )  ]
odd_gh
```

```{r}
weight_depth = 1/final_df$fit_gauss_sigma_depth^2
summary(weight_depth)
```

```{r}
weight_hg1 = 1/final_df$sigma_hg_coeff_1^2
summary(weight_hg1)
```

```{r}
weight_snr = final_df$mean_snr_pixel^2
summary(weight_snr)
```

```{r}
weight.pca = PCA(odd_gh, row.w = weight_snr, graph = F)
weight.pca$var$coord
```

```{r}
weight.pca = PCA(even_gh, row.w = weight_snr, graph = F)
weight.pca$var$coord
```


no weight
                Dim.1        Dim.2        Dim.3       Dim.4        Dim.5
hg_coeff_1  0.8177942  0.527744087  0.228258251  0.02442638 0.0006400212
hg_coeff_3 -0.9378263 -0.280474918  0.176934796  0.10206034 0.0096698075
hg_coeff_5  0.9859688 -0.003760346 -0.148460099  0.07240152 0.0238542397
hg_coeff_7 -0.9526834  0.292751010  0.006371553 -0.07771060 0.0247314004
hg_coeff_9  0.8606741 -0.478713327  0.153034615 -0.08095994 0.0099768920

weight (depth)
                Dim.1       Dim.2      Dim.3       Dim.4       Dim.5
hg_coeff_1  0.8186862  0.53724950  0.2002754  0.03170736 0.000597233
hg_coeff_3 -0.9368174 -0.30294435  0.1433361  0.09989105 0.008622775
hg_coeff_5  0.9877677 -0.01154764 -0.1401368  0.06390825 0.021424713
hg_coeff_7 -0.9480415  0.30889940  0.0157761 -0.07104389 0.022413160
hg_coeff_9  0.8567982 -0.48948101  0.1443702 -0.07336356 0.008957751

weight (hg1)
                Dim.1       Dim.2       Dim.3       Dim.4        Dim.5
hg_coeff_1  0.8208932  0.52649824  0.22058316  0.01664255 0.0002068336
hg_coeff_3 -0.9403097 -0.25603485  0.20270001  0.09546717 0.0079083703
hg_coeff_5  0.9873496 -0.02145002 -0.13121911  0.08356967 0.0218706512
hg_coeff_7 -0.9575921  0.27759504 -0.00916084 -0.07280232 0.0239631871
hg_coeff_9  0.8829668 -0.43710522  0.14758467 -0.08620987 0.0097619860

weight (snr)
                Dim.1       Dim.2        Dim.3       Dim.4        Dim.5
hg_coeff_1  0.8402967  0.49521112  0.219848817  0.01827202 0.0002223762
hg_coeff_3 -0.9491068 -0.21903040  0.203440065  0.09882880 0.0081894949
hg_coeff_5  0.9860542 -0.01864119 -0.142800804  0.08020893 0.0228935763
hg_coeff_7 -0.9650488  0.25029034 -0.003989304 -0.07345215 0.0249891372
hg_coeff_9  0.8954750 -0.40658187  0.162268702 -0.07987950 0.0101926608



# PCA

## odd hg

```{r}
odd_gh = final_df[ str_c( "hg_coeff_", as.character( seq(1,10,2) ) )  ]
odd_gh
```

```{r}
pairs(odd_gh)
```

```{r}
pcaOdd = prcomp(odd_gh, center = T, scale = T, retx = T)
```

```{r}
#calculate total variance explained by each principal component
var_explained = pcaOdd$sdev^2 / sum(pcaOdd$sdev^2)
var_explained
```

```{r}
# first 3 pcs
100*sum(var_explained[1:3])
```

```{r}
ggplot(mapping = aes(x = c(1:length(var_explained)),y = var_explained)) +
  geom_line() +
  geom_point() +
  xlab("Principal Component") + 
  ylab("Variance Explained")
```

```{r}
rm(odd_gh,var_explained)
```

## even hg

```{r}
even_gh = final_df[ str_c( "hg_coeff_", as.character( seq(0,10,2) ) )  ]
even_gh
```

```{r}
pairs(even_gh)
```

```{r}
pcaEven = prcomp(even_gh, center = T, scale = T, retx = T)
```

```{r}
#calculate total variance explained by each principal component
var_explained = pcaEven$sdev^2 / sum(pcaEven$sdev^2)
var_explained
```

```{r}
# first 3 pcs
100*sum(var_explained[1:3])
```

```{r}
ggplot(mapping = aes(x = c(1:length(var_explained)),y = var_explained)) +
  geom_line() +
  geom_point() +
  xlab("Principal Component") + 
  ylab("Variance Explained")
```

```{r}
rm(even_gh,var_explained)
```

## all hg
```{r}
all_gh = final_df[ str_c( "hg_coeff_", as.character( seq(0,10,1) ) )  ]
all_gh
```


```{r}
apply( all_gh, 2, var )
```

```{r}
summary(all_gh)
```

```{r}
all.pca = PCA(all_gh, graph = F, scale.unit = F)
all.pca$var$coord
```

```{r}
all.pca = PCA(all_gh, graph = F, scale.unit = T)
all.pca$var$coord
```

```{r}
plot.PCA(all.pca, choix = "var")
```

```{r}
plot.PCA(all.pca, choix = "var")
```

```{r}
plot.PCA(weight.pca, choix = "var")
```

```{r}
plot.PCA(weight.pca, choix = "var")
```



```{r}
#all_gh %>%
#  ggplot(mapping = aes(x = hg_coeff_1, y = hg_coeff_2)) +
#  geom_point()
```

```{r}
pairs(all_gh)
```

```{r}
pcaAll = prcomp(all_gh, center = T, scale = T, retx = T)
```


```{r}
#calculate total variance explained by each principal component
var_explained = pcaAll$sdev^2 / sum(pcaAll$sdev^2)
var_explained
```

```{r}
# first 5 pcs
100*sum(var_explained[1:5])
```

```{r}
ggplot(mapping = aes(x = c(1:length(var_explained)),y = var_explained)) +
  geom_line() +
  geom_point() +
  xlab("Principal Component") + 
  ylab("Variance Explained")
```

```{r}
rm(all_gh,var_explained)
```

# visual of line shifts

*get load.solarfile from raw_spectrum loading*

```{r}
# pick an abitrary line

i = 100

singleline.df = final_df %>%
  filter(line_order == lineIDs[i])

head(singleline.df)
```

```{r}
# sample three random days (before fire)
days = sample(singleline.df$date[singleline.df$date_groups == 1], 3)
days
```

```{r}
rawspectra.df = data.frame()

for (j in 1:length(days) ) {
  day = days[j]
  
  rawspectra.df = rbind(rawspectra.df,
        load.solarfile( str_c("solar_spectrum_",day,".h5") ) %>%
          # filter between low and high pixel values
          filter(pixel >= unique( singleline.df$pixel_extracted_lo ) & pixel <= unique(singleline.df$pixel_extracted_hi )) %>%
          # filter order
          filter(order == str_split_1(lineIDs[i], "_")[2])
        )
  
  
}
```

```{r}
rawspectra.df %>%
  ggplot() +
  xlim(4440.8,4440.94) +
  geom_point(mapping = aes(x = lambda, y = flux_norm, color = factor(date) )) +
  geom_smooth(mapping = aes(x = lambda, y = flux_norm, color = factor(date) ), se =F) +
  geom_vline(xintercept = ( singleline.df %>% filter(date == days[1]) )$fit_gauss_lambdac, color = "blue") +
  geom_vline(xintercept = ( singleline.df %>% filter(date == days[2]) )$fit_gauss_lambdac, color = "red") +
  geom_vline(xintercept = ( singleline.df %>% filter(date == days[3]) )$fit_gauss_lambdac, color = "green")
```

# pairs plots

```{r}
# covariates
covars = c("fit_gauss_a", "fit_gauss_b", "fit_gauss_depth", "fit_gauss_sigmasq","hg_coeff_0","hg_coeff_1", "hg_coeff_2","hg_coeff_4","hg_coeff_6")

# get rv dataframe
current_df = standardize(final_df, covars, RESPONSE_CHANGE = F, TRAIN_TEST_SPLIT = F) %>%
  mutate(date = factor(date),
         line_order = factor(line_order)) %>%
  select(rv_template_0.5, line_order, date, fit_gauss_a_centered, fit_gauss_b_centered, fit_gauss_depth_centered, fit_gauss_sigmasq_centered, hg_coeff_0_centered, hg_coeff_2_centered, hg_coeff_4_centered, hg_coeff_6_centered)
```

```{r}
var1 = "rv_template_0.5"
var2 = "fit_gauss_b_centered"


current_df %>%
  drop_na() %>%
  filter(line_order == lineIDs[271]) %>%
  ggplot() +
  geom_point(mapping = aes(x = !!sym(var2), y = !!sym(var1)), size = .5)
```

```{r}
rm(var1, var2, covar.list)
```

# rv over lines



```{r}
final_df %>%
  filter(line_order == lineIDs[30] ) %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = fit_gauss_lambdac), color = "black")
```


```{r}
final_df %>%
  #filter(date_groups == 2) %>%
  group_by(line_order, date_groups) %>%
  summarize(meanRV = mean(rv_template_0.5),
            medRV = median(rv_template_0.5) ,
            sdRV = sd(rv_template_0.5),
            n = n()) %>%
  mutate(seMean = sdRV/sqrt(n))
```

```{r}
final_df %>%
  #filter(date_groups == 2) %>%
  group_by(line_order, date_groups) %>%
  summarize(meanRV = mean(rv_template_0.5),
            medRV = median(rv_template_0.5) ,
            sdRV = sd(rv_template_0.5),
            n = n()) %>%
  mutate(seMean = sdRV/sqrt(n)) %>%
  arrange(medRV,sdRV) %>%
  filter(seMean < 10) %>%
  ggplot() +
  geom_point(mapping = aes(y = seMean, x = meanRV, color = factor(date_groups) ), alpha = .3)
```

```{r}
final_df %>%
  #filter(date_groups == 2) %>%
  group_by(line_order, date_groups) %>%
  summarize(meanRV = mean(rv_template_0.5),
            medRV = median(rv_template_0.5) ,
            sdRV = sd(rv_template_0.5)) %>%
  arrange(medRV,sdRV) %>%
  filter(sdRV < 100) %>%
  ggplot() +
  geom_point(mapping = aes(y = sdRV, x = meanRV, color = factor(date_groups) ), alpha = .3)
```

```{r}
final_df %>%
  filter(date_groups == 2) %>%
  group_by(line_order, lambdac_vald) %>%
  summarize(meanRV = mean(rv_template_0.5),
            medRV = median(rv_template_0.5) ,
            sdRV = sd(rv_template_0.5)) %>%
  arrange(medRV,sdRV) %>%
  filter(sdRV < 100) %>%
  ggplot() +
  geom_point(mapping = aes(y = sdRV, x = meanRV))

```

```{r}
final_df %>%
  group_by(line_order, lambdac_vald) %>%
  summarize(meanRV = mean(rv_template_0.5),
            medRV = median(rv_template_0.5) ,
            sdRV = sd(rv_template_0.5)) %>%
  arrange(medRV,sdRV) %>%
  #filter(abs(meanRV) < 25, sdRV < 20) %>%
  ggplot() +
  geom_point(mapping = aes(y = log(sdRV), x = meanRV))
```

```{r}
final_df %>%
  group_by(line_order, lambdac_vald) %>%
  summarize(meanRV = mean(rv_template_0.5),
            medRV = median(rv_template_0.5) ,
            sdRV = sd(rv_template_0.5)) %>%
  arrange(medRV,sdRV) %>%
  filter(log2(sdRV) < 4) %>%
  ggplot() +
  geom_point(mapping = aes(y = log2(sdRV), x = meanRV), alpha = .5)
```


```{r}
final_df %>%
  group_by(line_order, lambdac_vald) %>%
  summarize(meanRV = mean(rv_template_0.5),
            medRV = median(rv_template_0.5) ,
            sdRV = sd(rv_template_0.5)) %>%
  arrange(medRV,sdRV) %>%
  filter(abs(meanRV) < 25, log2(sdRV) < 6) %>%
  ggplot() +
  geom_point(mapping = aes(y = log2(sdRV), x = meanRV, color = lambdac_vald), alpha = .5)
```


```{r}
final_df %>%
  group_by(line_order, lambdac_vald) %>%
  summarize(meanRV = mean(rv_template_0.5),
            medRV = median(rv_template_0.5) ,
            sdRV = sd(rv_template_0.5)) %>%
  arrange(medRV,sdRV) %>%
  #filter(abs(meanRV) < 2.5) %>%
  ggplot() +
  geom_point(mapping = aes(x = log(sdRV), y = meanRV)) +
  ylim(-25,25) +
  xlim(1,4)
```


```{r}
final_df %>%
  group_by(line_order, lambdac_vald) %>%
  summarize(meanRV = mean(rv_template_0.5),
            medRV = median(rv_template_0.5) ,
            sdRV = sd(rv_template_0.5)) %>%
  arrange(medRV,sdRV) %>%
  #filter(abs(meanRV) < 2.5) %>%
  ggplot() +
  geom_point(mapping = aes(x = log(sdRV), y = medRV)) +
  ylim(-25,25) +
  xlim(1,4)
```

```{r}
currentLines = c(1:100)

final_df %>%
  filter(line_order %in% lineIDs[currentLines]) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = line_order, y = rv_template_0.5), outlier.shape = NA) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  ) +
  ylim(-20,20) +
  ggtitle(str_c(lineIDs[currentLines][1], " to ", lineIDs[currentLines][length(currentLines)]) )
  
```

```{r}
currentLines = c(101:200)

final_df %>%
  filter(line_order %in% lineIDs[currentLines]) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = line_order, y = rv_template_0.5)) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  ) +
  ylim(-200,200) +
  ggtitle(str_c(lineIDs[currentLines][1], " to ", lineIDs[currentLines][length(currentLines)]) )
  
```

```{r}
currentLines = c(501:600)

final_df %>%
  filter(line_order %in% lineIDs[currentLines]) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = line_order, y = rv_template_0.5)) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  ) +
  ylim(-200,200) +
  ggtitle(str_c(lineIDs[currentLines][1], " to ", lineIDs[currentLines][length(currentLines)]) )
  
```




etc.

# rv over time

## sample of a few lines

```{r}
# covariates
covars = c("fit_gauss_a", "fit_gauss_b", "fit_gauss_depth", 
             "fit_gauss_sigmasq", "hg_coeff_0", "hg_coeff_1", 
             "hg_coeff_2", "hg_coeff_3", "hg_coeff_4", 
             "hg_coeff_5", "hg_coeff_6", "hg_coeff_7", 
             "hg_coeff_8", "hg_coeff_9", "hg_coeff_10")
```

```{r}
# standardize data
current.df = standardize(final_df, covars = covars, covars.pca = covars, trainTestSplit = F)
```

```{r}
current.df %>%
  filter(line_order %in% sample( lineIDs, 4)) %>%
  ggplot(mapping = aes(x = date, y = rv_template_0.5_change, color = line_order) ) +
  geom_point(alpha = .2) +
  geom_line(alpha = .5)
  #theme(
  #  axis.text.x = element_blank(),
   # axis.ticks.x = element_blank()
  #)
```

```{r}
rm(covars, current.df)
```

## no perturbation

heat map

```{r}
final_df %>%
  filter(date <= dayIDs[10]) %>%
  mutate(date = as.factor(date)) %>%
  ggplot() +
  geom_bin2d(mapping = aes(x = date, y = rv_template_0.5), bins = 200  ) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  ) +
  ylim(-100,100)
```

```{r}
final_df %>%
  mutate(date = as.factor(date)) %>%
  filter(rv_template_0.5 < 100 & rv_template_0.5 > -100) %>%
  ggplot() +
  geom_bin2d(mapping = aes(x = date, y = rv_template_0.5), bins = 200  ) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  ) 
```

meanRV

```{r}
final_df %>%
  mutate(date = as.Date(date)) %>%
  group_by(date) %>%
  summarize(mean_RV = mean(rv_template_0.5) ) %>%
  ungroup() %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = mean_RV))
```

medianRV

```{r}
final_df %>%
  mutate(date = as.Date(date)) %>%
  group_by(date) %>%
  summarize(med_RV = median(rv_template_0.5) ) %>%
  ungroup() %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = med_RV))
```

mean change in rv over time quantile  bars

```{r}
final_df %>%
  group_by(date) %>%
  summarize( mean_RV = mean(rv_template_0.5),
             lower95 = quantile( rv_template_0.5, probs = c(0.025) ),
             upper95 = quantile( rv_template_0.5, probs = c(0.975) ) ) %>%
  ungroup() %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = mean_RV), size = 1) +
  geom_errorbar(aes(x = date, ymin = lower95, ymax = upper95), color = "black", linewidth = .25)
```

```{r}
final_df %>%
  group_by(date) %>%
  summarize( mean_RV = mean(rv_template_0.5),
             sd_error = sd(rv_template_0.5)/sqrt( n() ) ) %>%
  ungroup() %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = mean_RV), size = 1) +
  geom_errorbar(aes(x = date, ymin = mean_RV - 1.96*sd_error, ymax = mean_RV + 1.96*sd_error), color = "black", linewidth = .25)
```

density plots

```{r}
final_df %>%
  #filter(date %in% dayIDs[1:15]) %>%
  ggplot() +
  geom_density(mapping = aes(x = fit_gauss_b, color = date, group = date ) )
```

```{r}
final_df %>%
  filter(date %in% dayIDs[1:3]) %>%
  ggplot() +
  geom_density(mapping = aes(x = rv_template_0.5, color = factor(date) ) ) +
  xlim(-30,30)
```

```{r}
final_df %>%
  filter(date %in% dayIDs[1:5]) %>%
  ggplot() +
  geom_violin(mapping = aes(x = rv_template_0.5, y = factor(date) ) )
```

## w/ perturbation

### sample of a few lines

```{r}
# amplitude
amp = 2
# frequency
freq = 2*pi/366
```

```{r}
pert.df = final_df %>%
  filter(date_groups == 1) %>%
  dplyr::select(date, line_order, rv_template_0.5) %>%
  group_by(date) %>%
  mutate( date_num = as.numeric(date),
          pert_val = amp*sin(freq*date_num) ) %>%
  ungroup() %>%
  mutate(rv_template_0.5 = rv_template_0.5 + pert_val) %>%
  standardize(c(), trainTestSplit = F)
```

```{r}
pert.df %>%
  filter(line_order %in% sample( lineIDs, 2)) %>%
  ggplot(mapping = aes(x = date, y = rv_template_0.5_change, color = line_order) ) +
  geom_point(alpha = .2) +
  geom_line(alpha = .5)
```

```{r}
pert.df %>%
  dplyr::select(date,pert_val) %>%
  unique() %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = pert_val), color = "red")
```

### all lines

```{r}
pert.df %>%
  dplyr::select(date,pert_val) %>%
  unique() %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = pert_val), color = "red")
```

adding perturbation to rv_template_0.5:

```{r}
pert.df %>%
  mutate(rv_pert = rv_template_0.5 + pert_val) %>%
  group_by(date) %>%
  summarize(mean_RV = mean(rv_pert),
            pert = mean(pert_val)) %>%
  ungroup() %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = mean_RV)) +
  geom_point(mapping = aes(x = date, y = pert), color = "red")
```

```{r}
pert.df %>%
  mutate(rv_pert = rv_template_0.5 + pert_val) %>%
  group_by(date) %>%
  summarize(med_RV = median(rv_pert),
            pert = median(pert_val)) %>%
  ungroup() %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = med_RV)) +
  geom_point(mapping = aes(x = date, y = pert), color = "red")
```


```{r}
pert.df %>%
  mutate(rv_pert = rv_template_0.5 + pert_val) %>%
  group_by(date) %>%
  summarize(mean_RV = mean(rv_pert),
            sd_error = sd(rv_pert)/sqrt( n() ),
            pert = mean(pert_val)) %>%
  ungroup() %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = mean_RV)) +
  geom_point(mapping = aes(x = date, y = pert), color = "red") +
  geom_errorbar(aes(x = date, ymin = mean_RV - 1.96*sd_error, ymax = mean_RV + 1.96*sd_error), color = "black", linewidth = .25)
```

```{r}
pert.df %>%
  mutate(rv_pert = rv_template_0.5 + pert_val) %>%
  group_by(date) %>%
  summarize(med_RV = median(rv_pert),
            sd_error = sd(rv_pert)/sqrt( n() ),
            pert = mean(pert_val)) %>%
  ungroup() %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = med_RV)) +
  geom_point(mapping = aes(x = date, y = pert), color = "red") +
  geom_errorbar(aes(x = date, ymin = med_RV - 1.96*sd_error, ymax = med_RV + 1.96*sd_error), color = "black", linewidth = .25)
```

```{r}
rm(amp, freq, pert.df)
```





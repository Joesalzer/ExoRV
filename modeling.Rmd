---
title: "NEID Solar Data -- Linear Modeling"
author: "Joe Salzer"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(lme4)
library(MASS)
library(gridExtra)
library(car)
library(emmeans)
library(glmnet)
```

```{r}
## Data directory
wd_data = "/Users/josephsalzer/research/exostat/"
```

# Loading data

```{r}
# get species info for each line
species.df = read_csv(str_c(wd_data,"neid_solar/","clean_line_info.csv")) %>%
  dplyr::select(lambda, species, excitation_energy) %>%
  mutate(lambda = factor( round(lambda,3) ),
         species = factor(species)) %>%
  unique()
```


```{r}
# convert categorical vars to factors
model.df = tibble( read.csv(str_c(wd_data,"neid_solar/", "final_fits_6kmps.csv") ) ) %>%
  rename( wavelength = lambda ) %>%
  mutate( obs_date = factor(obs_date),
          lambda = factor(wavelength),
          order_idx = factor(order_idx),
          lam_order = factor( lam_order )
        )
```

```{r}
# join final fits and species
model.df = model.df %>%
  left_join(species.df, by = "lambda")
```

```{r}
rm(species.df)
```

```{r}
head(model.df)
```

```{r}
# list of lambdas in model.df
final_lams = ( model.df %>% group_by(lambda) %>% summarize(n. = n()) )$lambda
length(final_lams)
```
```{r}
# list of lambda-orders in model.df
final_lams_orders = ( model.df %>% group_by(lam_order) %>% summarize(n. = n()) )$lam_order
length(final_lams_orders)
```

```{r}
# list of lambda-orders in model.df
final_days = ( model.df %>% group_by(obs_date) %>% summarize(n. = n()) )$obs_date
length(final_days)
```

# Data summaries

```{r}
# check how many line-order pairs there are
model.df %>%
  group_by(lambda, order_idx) %>%
  count()
```
there are 310 line-order pairs, 146 observations per line-order pair

# PCA

## odd pca

```{r}
odd_gh = model.df[ str_c( "hg_", as.character( seq(1,12,2) ), "_scale" ) ]
odd_gh
```

```{r}
model.df %>%
  filter(wavelength < 8600) %>%
  ggplot(mapping = aes(x = hg_3_center, y =rv_center, color = wavelength)) +
  geom_point(alpha = .4)
```

```{r}
model.df %>%
  ggplot(mapping = aes(x = hg_1_center, y = hg_3_center, color = wavelength)) +
  geom_point(alpha = .4)
```

```{r}
pairs(odd_gh)
```

```{r}
pcaOdd = prcomp(odd_gh, center = T, scale = T, retx = T)
```

```{r}
#calculate total variance explained by each principal component
var_explained = pcaOdd$sdev^2 / sum(pcaOdd$sdev^2)
var_explained
```
```{r}
# first 3 pcs
100*sum(var_explained[1:3])
```

```{r}
ggplot(mapping = aes(x = c(1:length(var_explained)),y = var_explained)) +
  geom_line() +
  geom_point() +
  xlab("Principal Component") + 
  ylab("Variance Explained")
```


```{r}
rm(odd_gh,var_explained)
```

## even pca

```{r}
even_gh = model.df[ str_c( "hg_", as.character( seq(0,12,2) ), "_scale" ) ]
even_gh
```

```{r}
pairs(even_gh)
```

```{r}
pcaEven = prcomp(even_gh, center =T, scale =T, retx = T)
```

```{r}
#calculate total variance explained by each principal component
var_explained = pcaEven$sdev^2 / sum(pcaEven$sdev^2)
var_explained
```

```{r}
# first 3 pcs
100*sum(var_explained[1:3])
```

```{r}
ggplot(mapping = aes(x = c(1:length(var_explained)),y = var_explained)) +
  geom_line() +
  geom_point() +
  xlab("Principal Component") + 
  ylab("Variance Explained")
```

```{r}
rm(even_gh,var_explained)
```

## add pcs to dataframes

```{r}
# get pcs from each model
oddPCs = pcaOdd$x
evenPCs = pcaEven$x
```

```{r}
# modify column names
colnames(oddPCs) = str_c( "odd_", colnames(oddPCs) )
colnames(evenPCs) = str_c( "even_", colnames(evenPCs) )
```

```{r}
# add columns to our dataframes
model.df = cbind(model.df, oddPCs, evenPCs)
```

```{r}
rm(evenPCs, oddPCs, pcaEven, pcaOdd)
```

```{r}
model.df[ str_c( "odd_PC", as.character( seq(1,6) ) ) ] %>% pairs()
```

```{r}
model.df[ str_c( "even_PC", as.character( seq(1,6) ) ) ] %>% pairs()
```

# linear models

## model weighted 

```{r}
# add median snr for every line-order into the scaled dataframe
scaledmodel.df = scaledmodel.df %>%
  group_by(lam_order) %>%
  mutate( med_snr = median(snr) ) %>%
  ungroup()
```

```{r}
lm0 = lm(centered_rv ~ lam_order + obs_date , scaledmodel.df)
```

```{r}
lm0 = lm(centered_rv ~ lam_order + obs_date , scaledmodel.df, weights = snr)
```

```{r}
lm0 = lm(centered_rv ~ lam_order + obs_date , scaledmodel.df, weights = med_snr)
```

```{r}
lm0 = lm(centered_rv ~ lam_order + obs_date + b1 + gh_3 + gh_2 + gh_5 + 
    gh_7 + depth1 + gh_9 + a1 + gh_11 + gh_4 + width1 + 
    gh_0 + gh_10, data=scaledmodel.df ) 
```

```{r}
lm0 = lm(centered_rv ~ lam_order + obs_date + b1 + gh_3 + gh_2 + gh_5 + 
    gh_7 + depth1 + gh_9 + a1 + gh_11 + gh_4 + width1 + 
    gh_0 + gh_10, data=scaledmodel.df, weights = med_snr ) 
```

```{r}
lm0 = lm(centered_rv ~ lam_order + obs_date + b1 + gh_3 + gh_2 + gh_5 + 
    gh_7 + depth1 + gh_9 + a1 + gh_11 + gh_4 + width1 + 
    gh_0 + gh_10, data=scaledmodel.df, weights = snr ) 
```


```{r}
# the current linear model to be worked on
currentlm = lm0
# dataframe of coefficients of currentlm 
coef.df = tibble( coef = rownames(summary(currentlm )$coefficients),
                  estimate = summary(currentlm )$coefficients[,1],
                  se = summary(currentlm )$coefficients[,2],
                  pval = summary(currentlm )$coefficients[,4] )
```

```{r}
coef.df
```

```{r}
# get emmeans 
emmean.summary = summary( emmeans(currentlm, "obs_date", nuisance = "lam_order") )
```

```{r}
emmean.summary %>%
  ggplot() +
  geom_histogram(mapping = aes(emmean))
```


```{r}
emmean.summary %>%
  ggplot() +
  geom_point(aes(x = as.Date(obs_date), y = emmean), color = "black") +
  geom_errorbar(aes(x = as.Date(obs_date), ymin = emmean - 1.96*SE, ymax = emmean + 1.96*SE), color = "black") +
  geom_hline(yintercept = 0, color = "red")
```
```{r}
sd(emmean.summary$emmean)
```

```{r}
ggplot() +
  geom_density(mapping = aes(x = currentlm$residuals))

summary(currentlm$residuals)
```

```{r}
sqrt( sum(currentlm$residuals^2)/( nrow(scaledmodel.df)  - 45101 ) )
```


```{r}
plot(currentlm,which=1)
```

```{r}
plot(currentlm,which=2)
```


```{r}
# R2 of model
summary(currentlm)$adj.r.squared
# rse of model
summary(currentlm)$sigma
# se on date emmean
mean( emmean.summary$SE )
# how many dates are statistically different than 0 (95% confidence)
sum( !(emmean.summary$lower.CL <= 0 & emmean.summary$upper.CL >= 0) )
```


Response: centered rv

  Model: lam_order + obs_date (no weight)
    R^2 = 0.002085831
    RSE = 12.09085
    se on date emmean = 0.6867143
    number of dates that are statistically different than 0 (95% CI) = 36
    
  Model: lam_order + obs_date (med snr^2 weight)
    R^2 = 0.008960191
    RSE = 1511107 ***
    se on date emmean = 1.47265
    number of dates that are statistically different than 0 (95% CI) = 5
  
  Model: lam_order + obs_date (snr^2 weight)
    R^2 = 0.01162692
    RSE = 1475669 ***
    se on date emmean = 1.465805
    number of dates that are statistically different than 0 (95% CI) = 5
    
  Model: full model (no weight)
    R^2 = 0.8342954
    RSE = 4.926944
    se on date emmean = 0.2800749
    number of dates that are statistically different than 0 (95% CI) = 11
    
  Model: full model (med snr^2 weight)
    R^2 = 0.8073926
    RSE = 666171.7 ***
    se on date emmean = 0.6493029
    number of dates that are statistically different than 0 (95% CI) = 0
  
  Model: full model (snr^2 weight)
    R^2 = 0.8061024
    RSE = 653604.1 ***
    se on date emmean = 0.6493199
    number of dates that are statistically different than 0 (95% CI) = 0
  
    

```{r}
rm(lm0, coef.df, currentlm, emmean.summary)
```

## model 0 (date dependence only)

Response: centered_rv
  
  adj.r.squared: 0.008392062
  RSE: 11.54451
  standard error of date effect: 0.6556838
  percent of days that aren't statistically different than 0 (normal, 95%): 0.7465753
  percent of days that aren't statistically different than 0 (normal, 99%): 0.869863
  
Response: scale_rv
  
  adj.r.squared: 0.05831735
  RSE: 0.967085
  standard error of date effect: 0.05492674
  percent of days that aren't statistically different than 0 (normal, 95%): 0.4178082
  percent of days that aren't statistically different than 0 (normal, 99%): 0.5

```{r}
# the current linear model to be worked on
currentlm = lm(rv_center ~ obs_date + depth1_center + width1_center + a1_center + b1_center, model.df)
```

```{r}
# get emmeans 
emmean.summary = summary( emmeans(currentlm, "obs_date", nuisance = "lam_order") )
```

```{r}
# dataframe of coefficients of currentlm 
# coef.df = tibble( coef = rownames(summary(currentlm )$coefficients),
#                   estimate = summary(currentlm )$coefficients[,1],
#                   se = summary(currentlm )$coefficients[,2],
#                   pval = summary(currentlm )$coefficients[,4] )
```

```{r}
# adj.r.squared
summary(currentlm)$adj.r.squared
# RSE
summary(currentlm)$sigma
# standard error of date effect (mean)
mean(emmean.summary$SE)
# percent of days that aren't statistically different than 0 (95%)
mean(
  (emmean.summary$emmean - qnorm(.975)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(.975)*emmean.summary$SE > 0)
)
# percent of days aren't statistically different than 0 (99%)
mean(
  (emmean.summary$emmean - qnorm(0.995)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(0.995)*emmean.summary$SE > 0)
)
```

```{r}
emmean.summary %>%
  ggplot() +
  geom_point(aes(x = as.Date(obs_date), y = emmean), color = "black") +
  geom_errorbar(aes(x = as.Date(obs_date), ymin = emmean - 1.96*SE, ymax = emmean + 1.96*SE), color = "black") +
  geom_hline(yintercept = 0, color = "red")
```

```{r}
plot(currentlm,which=1)
```

```{r}
plot(currentlm,which=2)
```

```{r}
rm(currentlm, coef.df, emmean.summary)
```

## model 1 (chosen stepwise regression)

```{r}
# the current linear model to be worked on
currentlm = lm(rv_center ~ obs_date + hg_0_center + hg_2_center + hg_3_center + hg_4_center + hg_5_center + hg_6_center + hg_7_center + hg_8_center + hg_9_center + hg_10_center + hg_11_center + a1_center + depth1_center + width1_center + b1_center, data=model.df) 
```

removing some lines
```{r}
# the current linear model to be worked on
currentlm = lm(rv_center ~ obs_date + hg_0_center + hg_2_center + hg_3_center + hg_4_center + hg_5_center + hg_6_center + hg_7_center + hg_8_center + hg_9_center + hg_10_center + hg_11_center + a1_center + depth1_center + width1_center + b1_center, data=model.df %>% filter(wavelength > 8600)) 
```

```{r}
# get emmeans 
emmean.summary = summary( emmeans(currentlm, "obs_date", nuisance = "lam_order") )
```

```{r}
# dataframe of coefficients of currentlm 
coef.df = tibble( coef = rownames(summary(currentlm )$coefficients),
                  estimate = summary(currentlm )$coefficients[,1],
                  se = summary(currentlm )$coefficients[,2],
                  pval = summary(currentlm )$coefficients[,4] )
```

```{r}
# adj.r.squared
summary(currentlm)$adj.r.squared
# RSE
summary(currentlm)$sigma
# standard error of date effect (mean)
mean(emmean.summary$SE)
# percent of days that aren't statistically different than 0 (95%)
mean(
  (emmean.summary$emmean - qnorm(.975)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(.975)*emmean.summary$SE > 0)
)
# percent of days aren't statistically different than 0 (99%)
mean(
  (emmean.summary$emmean - qnorm(0.995)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(0.995)*emmean.summary$SE > 0)
)
```

new model, centering shape measurements (no scaling on features):
[1] 0.8297888
[1] 4.78299
[1] 0.271907
[1] 0.9383562
[1] 0.9863014

new model, centering shape measurements (no scaling on features), removing wavelength > 8600 lines:
[1] 0.9684441
[1] 6.347473
[1] 1.502136
[1] 0.9520548
[1] 0.9726027

```{r}
# add column of predicted rv to test dataframe
#predict(currentlm)
```

```{r}
model.df %>%
  filter(wavelength > 8600) %>%
  ggplot(mapping = aes(x = rv_center, y = predict(currentlm), color = snr)) +
  geom_point() +
  geom_abline(slope=1,intercept=0,linetype = 2)
```

```{r}
emmean.summary
```


```{r}
emmean.summary %>%
  ggplot() +
  geom_point(aes(x = as.Date(obs_date), y = emmean), color = "black") +
  geom_errorbar(aes(x = as.Date(obs_date), ymin = emmean - 1.96*SE, ymax = emmean + 1.96*SE), color = "black") +
  geom_hline(yintercept = 0, color = "red")
```

```{r}
plot(currentlm,which=1)
```

```{r}
plot(currentlm,which=2)
```


```{r}
rm(coef.df, currentlm, emmean.summary)
```

## model 2 (hg1 + obsdate alone)

Response: centered_rv
  
  adj.r.squared: 0.1267902
  RSE: 10.8334
  standard error of date effect: 0.6154992
  percent of days that aren't statistically different than 0 (normal, 95%): 0.8835616
  percent of days that aren't statistically different than 0 (normal, 99%): 0.9863014
  
Response: scale_rv
  
  adj.r.squared: 0.5347835
  RSE: 0.6797354
  standard error of date effect: 0.03861915
  percent of days that aren't statistically different than 0 (normal, 95%): 0.3356164
  percent of days that aren't statistically different than 0 (normal, 99%): 0.4863014

```{r}
# the current linear model to be worked on
currentlm = lm(rv_scale ~ obs_date + hg_1_scale, model.df)
```

```{r}
# get emmeans 
emmean.summary = summary( emmeans(currentlm, "obs_date", nuisance = "lam_order") )
```

```{r}
# dataframe of coefficients of currentlm 
# coef.df = tibble( coef = rownames(summary(currentlm )$coefficients),
#                   estimate = summary(currentlm )$coefficients[,1],
#                   se = summary(currentlm )$coefficients[,2],
#                   pval = summary(currentlm )$coefficients[,4] )
```

```{r}
# adj.r.squared
summary(currentlm)$adj.r.squared
# RSE
summary(currentlm)$sigma
# standard error of date effect (mean)
mean(emmean.summary$SE)
# percent of days that aren't statistically different than 0 (95%)
mean(
  (emmean.summary$emmean - qnorm(.975)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(.975)*emmean.summary$SE > 0)
)
# percent of days aren't statistically different than 0 (99%)
mean(
  (emmean.summary$emmean - qnorm(0.995)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(0.995)*emmean.summary$SE > 0)
)
```

```{r}
emmean.summary %>%
  ggplot() +
  geom_point(aes(x = as.Date(obs_date), y = emmean), color = "black") +
  geom_errorbar(aes(x = as.Date(obs_date), ymin = emmean - 1.96*SE, ymax = emmean + 1.96*SE), color = "black") +
  geom_hline(yintercept = 0, color = "red")
```

```{r}
plot(currentlm,which=1)
```

```{r}
plot(currentlm,which=2)
```

```{r}
rm(currentlm, coef.df, emmean.summary)
```

## model 3 (two shape changes)

```{r}
# the current linear model to be worked on
currentlm = lm(rv_scale ~ obs_date + hg_1_scale, model.df)
```

```{r}
# get emmeans 
emmean.summary = summary( emmeans(currentlm, "obs_date", nuisance = "lam_order") )
```

```{r}
# dataframe of coefficients of currentlm 
# coef.df = tibble( coef = rownames(summary(currentlm )$coefficients),
#                   estimate = summary(currentlm )$coefficients[,1],
#                   se = summary(currentlm )$coefficients[,2],
#                   pval = summary(currentlm )$coefficients[,4] )
```

```{r}
# adj.r.squared
summary(currentlm)$adj.r.squared
# RSE
summary(currentlm)$sigma
# standard error of date effect (mean)
mean(emmean.summary$SE)
# percent of days that aren't statistically different than 0 (95%)
mean(
  (emmean.summary$emmean - qnorm(.975)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(.975)*emmean.summary$SE > 0)
)
# percent of days aren't statistically different than 0 (99%)
mean(
  (emmean.summary$emmean - qnorm(0.995)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(0.995)*emmean.summary$SE > 0)
)
```

```{r}
emmean.summary %>%
  ggplot() +
  geom_point(aes(x = as.Date(obs_date), y = emmean), color = "black") +
  geom_errorbar(aes(x = as.Date(obs_date), ymin = emmean - 1.96*SE, ymax = emmean + 1.96*SE), color = "black") +
  geom_hline(yintercept = 0, color = "red")
```


## model for rv (PCs)

Response: centered_rv
  
  adj.r.squared: 0.1267902
  RSE: 10.8334
  standard error of date effect: 0.6154992
  percent of days that aren't statistically different than 0 (normal, 95%): 0.8835616
  percent of days that aren't statistically different than 0 (normal, 99%): 0.9863014
  
Response: scale_rv
  
  adj.r.squared: 0.5863582
  RSE: 0.6409506
  standard error of date effect: 0.03645436
  percent of days that aren't statistically different than 0 (normal, 95%): 0.869863
  percent of days that aren't statistically different than 0 (normal, 99%): 0.9657534

```{r}
# the current linear model to be worked on
currentlm = lm(rv_scale ~ obs_date + odd_PC1 + odd_PC2 + odd_PC3 + even_PC1 + even_PC2 + even_PC3, model.df)
```

```{r}
# get emmeans 
emmean.summary = summary( emmeans(currentlm, "obs_date", nuisance = "lam_order") )
```

```{r}
# dataframe of coefficients of currentlm 
# coef.df = tibble( coef = rownames(summary(currentlm )$coefficients),
#                   estimate = summary(currentlm )$coefficients[,1],
#                   se = summary(currentlm )$coefficients[,2],
#                   pval = summary(currentlm )$coefficients[,4] )
```

```{r}
# adj.r.squared
summary(currentlm)$adj.r.squared
# RSE
summary(currentlm)$sigma
# standard error of date effect (mean)
mean(emmean.summary$SE)
# percent of days that aren't statistically different than 0 (95%)
mean(
  (emmean.summary$emmean - qnorm(.975)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(.975)*emmean.summary$SE > 0)
)
# percent of days aren't statistically different than 0 (99%)
mean(
  (emmean.summary$emmean - qnorm(0.995)*emmean.summary$SE < 0) & (emmean.summary$emmean + qnorm(0.995)*emmean.summary$SE > 0)
)
```

```{r}
emmean.summary %>%
  ggplot() +
  geom_point(aes(x = as.Date(obs_date), y = emmean), color = "black") +
  geom_errorbar(aes(x = as.Date(obs_date), ymin = emmean - 1.96*SE, ymax = emmean + 1.96*SE), color = "black") +
  geom_hline(yintercept = 0, color = "red")
```

```{r}
plot(currentlm,which=1)
```

```{r}
plot(currentlm,which=2)
```

```{r}
rm(currentlm, emmean.summary)
```

# Variance inflation factor

```{r, eval = F}
# removing non-singularities from lm above
vif.df = 
  as_tibble( model.matrix(~ centered_rv + lambda*b1 + order_idx + obs_date + gh_3 + gh_2 + gh_5 + 
    gh_7 + depth1 + gh_9 + a1 + snr + gh_11 + gh_4 + width1 + 
    gh_0 + gh_10, data = scaledmodel.df) ) %>%
  dplyr::select(!attributes(alias(lm3)$Complete)$dimnames[[1]]) %>%
  dplyr::select(!"(Intercept)")

# run lm on modified dataframe (that excluded non-singularities)
vif.lm = lm(centered_rv ~ ., data = vif.df)

# check if r2 and rmse are the same 
summary(vif.lm)$adj.r.squared
summary(vif.lm)$sigma

vif.coefs = vif(vif.lm)

# every single coefficient has vif of NaN...
all( is.nan(vif.coefs) )

rm(vif.df,vif.lm,vif.coefs)
```

*Strange results when removing non-singularities from og model (should be the exact same fit as that model). This occurs even when I remove the "problem" categorical variables like order_idx, and lambda b1 interaction.*

Instead, remove all categorical (lambda, order_idx, obs_date):

```{r}
vif.lm = lm(centered_rv ~ b1 + gh_5 + depth1 + a1 + snr  + width1 + 
    gh_0, data = scaledmodel.df)
 
t( t( vif(vif.lm) ) )
```

```{r}
vif.lm = lm(centered_rv ~ lambda*b1 + order_idx + obs_date + gh_1 + gh_2 + gh_4 + gh_3 + gh_5 + depth1 + a1 + snr  + width1 + gh_0, data = scaledmodel.df)
```

```{r}
summary(vif.lm)$adj.r.squared
summary(vif.lm)$sigma
```

as expected, most gh coefficients are highly collinear whereas most other covariates are not collinear

```{r}
summary(scaledmodel.df)
```

```{r}
rm(lm3, coef.df, vif.lm)
```


# injecting perturbations in RV

### random noise

```{r}
pert.df = model.df %>%
  group_by(obs_date) %>%
  mutate(pert_val = rnorm(1, sd = 2)) %>%
  ungroup() %>%
  mutate(rv_pert = rv + pert_val,
         centered_rv_pert = centered_rv + pert_val)
```

```{r}
# graph of perturbation
pert.df %>%
  dplyr::select(obs_date, pert_val) %>%
  unique() %>%
  ggplot() +
  geom_point(mapping = aes(x = as.Date(obs_date), y = pert_val))
```


```{r}
lm.pert = lm(centered_rv_pert ~ lam_order + obs_date + b1, pert.df, weights = 1/snr^2 )
# dataframe of coefficients
coef.df = tibble( coef = rownames(summary(lm.pert)$coefficients),
                  estimate = summary(lm.pert)$coefficients[,1],
                  se = summary(lm.pert)$coefficients[,2],
                  pval = summary(lm.pert)$coefficients[,4] )
```

```{r}
coef.df %>% filter( startsWith( coef, "(Intercept)") )
```

```{r}
coef.df %>% filter( startsWith( coef, "obs_date") )
```

```{r}
# get emmeans 
emmean.summary = summary( emmeans(lm.pert, "obs_date", nuisance = "lam_order") )
date.emmeans = emmean.summary$emmean
date.se = emmean.summary$SE
# get perturbed values by date
date.perts = pert.df$pert_val %>% unique()
```

note that the standard errors of the model estimates and once we subtract out the first date

```{r}
sqrt( 2*date.se[1]^2 )
```

```{r}
date.emmeans - date.emmeans[1]
```

```{r}
# join the perturbed dataframe with the coefficients to compare our perturbed obsdate with 
date.pert.table = full_join(
  pert.df %>%
    dplyr::select(obs_date, pert_val) %>%
    unique() %>%
    mutate(obs_date = as.Date(obs_date)),
  coef.df %>%
    filter( startsWith( coef, "obs_date") ) %>%
    mutate(obs_date = as.Date(str_sub(coef, 9))),
  by = "obs_date"
  )
date.pert.table$emmean = date.emmeans
date.pert.table$emmeanSE = date.se
```

```{r}
date.pert.table
```


```{r}
date.pert.table %>%
  ggplot() +
  geom_point(aes(x = obs_date, y = emmean), color = "black") +
  geom_errorbar(aes(x = obs_date, ymin = emmean - 1.96*emmeanSE, ymax = emmean + 1.96*emmeanSE), color = "black") +
  geom_point(aes(x = obs_date, y = pert_val), color = "red") +
  xlab("obs date")
```

```{r}
date.pert.table %>%
  mutate(diff = pert_val - emmean) %>%
  ggplot() +
  geom_point(aes(x = obs_date, y = diff), color = "black") +
  xlab("obs date") +
  ylab("difference between perturbed value and obs date estimate")
```

mean difference between perturbed value and obs date estimate
```{r}
date.pert.table %>%
  mutate(diff = pert_val - emmean) %>%
  summarize(mean_diff = mean(diff))
```


```{r}
rm(lm.pert,pert.df,coef.df,date.emmeans,date.se,date.pert.table,emmean.summary, date.perts)
```


### random sinusodial noise


```{r}
# amplitude
amp = 2
# frequency
freq = 1/30
```


```{r}
# create perturbed df where each day is perturbed by a sinusodial wave
# date_num is the obsdate converted to a numerical and divided to decrease freq of perturbation
# sin_date is 1 times the sin of date_num
pert.df = model.df %>%
  group_by(obs_date) %>%
  mutate(date_num = as.numeric(as.Date(obs_date)),
         pert_val = amp*sin(freq*date_num)) %>%
  ungroup() %>%
  mutate(rv_pert_center = rv_center + pert_val)
pert.df
```

old:
```{r}
# create perturbed df where each day is perturbed by a sinusodial wave
# date_num is the obsdate converted to a numerical and divided to decrease freq of perturbation
# sin_date is 1 times the sin of date_num
pert.df = model.df %>%
  group_by(obs_date) %>%
  mutate(date_num = as.numeric(as.Date(obs_date)),
         pert_val = amp*sin(freq*date_num)) %>%
  ungroup() %>%
  mutate(rv_pert = rv + pert_val) %>%
  dplyr::select(!c(rv_center, rv_scale)) %>%
  # we ought to redo our centering and scaling after we add the perturbation
  group_by(lam_order) %>%
  mutate( rv_pert_center = rv_pert - mean(rv_pert),
          rv_pert_scale = rv_pert_center/sd(rv_pert)) %>%
  ungroup()
pert.df
```

```{r}
# graph of perturbation
pert.df %>%
  dplyr::select(date_num, pert_val) %>%
  unique() %>%
  ggplot() +
  geom_function(fun = function(x) amp*sin(freq*x), color = "red" ) +
  geom_point(mapping = aes(x = date_num, y = pert_val))
```


```{r}
lm.pert = lm(rv_pert_center ~ obs_date + b1_center + a1_center + depth1_center + width1_center + hg_0_center + hg_2_center + hg_3_center + hg_4_center + hg_5_center + hg_7_center + hg_9_center, pert.df)
# dataframe of coefficients
coef.df.pert = tibble( coef = rownames(summary(lm.pert)$coefficients),
                  estimate = summary(lm.pert)$coefficients[,1],
                  se = summary(lm.pert)$coefficients[,2],
                  pval = summary(lm.pert)$coefficients[,4] )
```

```{r}
lm.pert = lm(rv_pert_center ~ obs_date + b1_scale, pert.df)
# dataframe of coefficients
coef.df.pert = tibble( coef = rownames(summary(lm.pert)$coefficients),
                  estimate = summary(lm.pert)$coefficients[,1],
                  se = summary(lm.pert)$coefficients[,2],
                  pval = summary(lm.pert)$coefficients[,4] )
```


```{r}
# get emmeans 
emmean.summary = summary( emmeans(lm.pert, "obs_date", nuisance = "lam_order") )
date.emmeans = emmean.summary$emmean
date.se = emmean.summary$SE
# get perturbed values by date
date.perts = pert.df$pert_val %>% unique()
```

```{r}
# join the perturbed dataframe with the coefficients to compare our perturbed obsdate with 
date.pert.table = full_join(
  pert.df %>%
    dplyr::select(obs_date, pert_val) %>%
    unique() %>%
    mutate(obs_date = as.Date(obs_date)),
  coef.df.pert %>%
    filter( startsWith( coef, "obs_date") ) %>%
    mutate(obs_date = as.Date(str_sub(coef, 9))),
  by = "obs_date"
  )
date.pert.table$emmean = date.emmeans
date.pert.table$emmeanSE = date.se
```

```{r}
date.pert.table %>%
  ggplot() +
  geom_point(aes(x = obs_date, y = emmean), color = "black") +
  geom_errorbar(aes(x = obs_date, ymin = emmean - 1.96*emmeanSE, ymax = emmean + 1.96*emmeanSE), color = "black") +
  geom_point(aes(x = obs_date, y = pert_val), color = "red") +
  geom_function(fun = function(x) amp*sin(freq*as.numeric(x)), color = "red" ) +
  xlab("obs date")
```

```{r}
date.pert.table %>%
  mutate(diff = pert_val - emmean) %>%
  ggplot() +
  geom_point(aes(x = obs_date, y = diff), color = "black") +
  xlab("obs date") +
  ylab("difference between perturbed value and obs date estimate")
```



mean difference between perturbed value and obs date estimate
```{r}
date.pert.table %>%
  mutate(diff = pert_val - emmean) %>%
  summarize(mean_diff = mean(diff),
            sd_dff = sd(diff),
            median_diff = median(diff))
```



```{r}
rm(lm.pert,pert.df,date.emmeans,date.se,date.pert.table,emmean.summary, date.perts,amp,freq,coef.df.pert)
```


# LASSO

*LASSO: no interaction terms*

```{r}
# categorical variables
cat.df = as_tibble( model.matrix(~ obs_date, data = model.df %>% drop_na() )  ) %>%
  dplyr::select(!"(Intercept)")
cat.df
```

```{r}
# covariates not-including categorical variables
covar.df = model.df %>%
  dplyr::select(hg_0_scale,hg_2_scale,hg_3_scale,hg_4_scale,hg_5_scale,hg_6_scale,hg_7_scale,hg_8_scale,hg_9_scale,hg_10_scale,a1_scale,depth1_scale,width1_scale,b1_scale) %>%
  drop_na()
covar.df
```

```{r}
# covariates not-including categorical variables
covar.df = model.df %>%
  dplyr::select(odd_PC1,odd_PC2,odd_PC3,odd_PC4,odd_PC5,odd_PC6,even_PC1,even_PC2,even_PC3,even_PC4,even_PC5,even_PC6,even_PC7,a1_scale,depth1_scale,width1_scale,b1_scale) %>%
  drop_na()
covar.df
```

```{r}
# combine categorical and non-categorical variables into one matrix
# non-categorical vars appear before categorical vars
Xlasso = data.matrix( cbind(covar.df,cat.df) )
dim(Xlasso)

# number of covariates
n.covar = dim(covar.df)[2]
n.covar
# number of categories
n.cat = ncol(Xlasso) - n.covar
n.cat
```

```{r}
# cv lasso, penalty factor means we only have penalties on non-categorical vars
cv_model1 = cv.glmnet(Xlasso, 
                     model.df$rv_center,
                     penalty.factor = c( rep(1,n.covar), rep(0,n.cat)),
                     alpha = 1)
```

```{r}
cv_model1$lambda.min
cv_model1$lambda.1se
plot(cv_model1)
```

```{r}
# create the best model using the min lambda
best.model1 = glmnet(Xlasso, 
                     model.df$rv_center,
                     penalty.factor = c( rep(1,n.covar), rep(0,n.cat)),
                     alpha = 1,
                     lambda = cv_model1$lambda.1se)
```

```{r}
# look at coeficients of non-cat vars
head( coef(best.model1), n.covar + 1 )
```

                     s0
(Intercept)   0.2953072
hg_0_scale    .        
hg_2_scale   -0.6158702
hg_3_scale    2.5972034
hg_4_scale    .        
hg_5_scale    .        
hg_6_scale    .        
hg_7_scale    .        
hg_8_scale    .        
hg_9_scale    0.1624563
hg_10_scale   .        
a1_scale      .        
depth1_scale  .        
width1_scale  .        
b1_scale      2.4818761


```{r}
rm(best.model1,cat.df,covar.df,cv_model1,Xlasso,n.cat,n.covar)
```

*LASSO: with interaction terms b/w non-categorical variables*

```{r}
covar2.df = model.matrix( ~ 0 + .^2, data = covar.df)
```


```{r}
# combine categorical and non-categorical variables into one matrix
# non-categorical vars appear before categorical vars
Xlasso = data.matrix( cbind(covar2.df,cat.df) )
dim(Xlasso)

# number of covariates
n.covar = dim(covar2.df)[2]
n.covar
# number of categories
n.cat = ncol(Xlasso) - n.covar
n.cat
```

```{r}
# cv lasso, penalty factor means we only have penalties on non-categorical vars
cv_model = cv.glmnet(Xlasso, 
                     centered_rv,
                     penalty.factor = c( rep(1,n.covar), rep(0,n.cat)),
                     alpha = 1)
```


```{r}
cv_model$lambda.min
plot(cv_model)
```

```{r}
# create the best model using the min lambda
best.model = glmnet(Xlasso, 
                     centered_rv,
                     penalty.factor = c( rep(1,n.covar), rep(0,n.cat)),
                     alpha = 1,
                     lambda = cv_model$lambda.min)
```

```{r}
# look at coeficients of non-cat vars
head( coef(best.model), n.covar + 1 )
```

# stepwise model


```{r, eval = F}
# record the current time beforechunk
now = Sys.time()

# modify the og dataframe to keep only the necessary variables
df.step = scaledmodel.df %>%
  dplyr::select(centered_rv, lam_order, obs_date, 
                gh_0, gh_2, gh_3, gh_4, gh_5 , gh_6 , gh_7 , gh_8 , gh_9 , gh_10 , gh_11 , gh_12,
                snr, a1, depth1, width1, b1, colnames(scaledmodel.df)[71:96]) %>% 
  drop_na()

# base or the starting modeling
base.mdl = lm(centered_rv ~ lam_order + obs_date, data=df.step)
# full model
full.mdl = lm(centered_rv ~ lam_order + obs_date + ., data=df.step)

# k=2 uses AIC, k=log(n) n = sample size uses BIC
step.mdl = step(base.mdl, scope = list(lower = base.mdl, upper = full.mdl), direction = "both", k = 2)

# calculate the time difference after a chunk
res = difftime(Sys.time(), now, units = "secs")
# return a character string to show the time
paste("Time for this code chunk to run:", res)
```


```{r}
rm(base.mdl, df.step, full.mdl, step.mdl, now, res)
```








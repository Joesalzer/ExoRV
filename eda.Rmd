---
title: "NEID Solar Data -- EDA"
author: "Joe Salzer"
date: "`r Sys.Date()`"
output: html_document
---

EDA for final fits dataframe, various visuals and summaries

<!-- # ```{r setup, include=FALSE} -->
<!-- # knitr::opts_chunk$set(echo = TRUE) -->
<!-- # library(tidyverse) -->
<!-- # library(stringr) -->
<!-- # library(readxl) -->
<!-- # library(lme4) -->
<!-- # library(MASS) -->
<!-- # library(gridExtra) -->
<!-- # library(gtools) -->
<!-- # ``` -->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
```

```{r}
## Data directory
wd_data = "/Users/josephsalzer/research/exostat/"
```

# Loading data

```{r}
# get species info for each line
species.df = read_csv(str_c(wd_data,"neid_solar/","clean_line_info.csv")) %>%
  dplyr::select(lambda, species, excitation_energy) %>%
  mutate(lambda = factor( round(lambda,3) ),
         species = factor(species)) %>%
  unique()
```


```{r}
# convert categorical vars to factors
model.df = tibble( read.csv(str_c(wd_data,"neid_solar/", "final_fits_6kmps.csv") ) ) %>%
  rename( wavelength = lambda ) %>%
  mutate( obs_date = as.Date(obs_date),
          lambda = factor(wavelength),
          order_idx = factor(order_idx),
          lam_order = factor( lam_order )
        )
```

```{r}
# join final fits and species
model.df = model.df %>%
  left_join(species.df, by = "lambda")
```

```{r}
rm(species.df)
```

```{r}
head(model.df)
```

```{r}
# list of lambdas in model.df
final_lams = ( model.df %>% group_by(lambda) %>% summarize(n. = n()) )$lambda
length(final_lams)
```
```{r}
# list of lambda-orders in model.df
final_lams_orders = ( model.df %>% group_by(lam_order) %>% summarize(n. = n()) )$lam_order
length(final_lams_orders)
```

```{r}
# list of lambda-orders in model.df
final_days = ( model.df %>% group_by(obs_date) %>% summarize(n. = n()) )$obs_date
length(final_days)
```
# Data summaries

```{r}
# check how many line-order pairs there are
model.df %>%
  group_by(lambda, order_idx) %>%
  count()
```
there are 310 line-order pairs, 147 observations per line-order pair

```{r}
summary(model.df)
```

# pairs plots

```{r}
covar.list = c("gh_0", "gh_2", "gh_3", "gh_4", "gh_5", "gh_6", "gh_7", "gh_8", "gh_9", "gh_10", "gh_11", "gh_12", "snr", "a1", "depth1", "width1", "b1")

covar.combinations = combinations(length(covar.list),2)
```

```{r}
dim(covar.combinations)
```

```{r}
for (i in c(1:30)) {
  row.vec = covar.combinations[i,]
  covar1 = row.vec[1]
  covar2 = row.vec[2]
  
  print(
    model.df %>%
      drop_na() %>%
      ggplot() +
      geom_point(mapping = aes(x = !!sym(covar.list[covar1]), y = !!sym(covar.list[covar2]), color = wavelength))
  )
  
}
```


```{r}
for (i in c(31:60)) {
  row.vec = covar.combinations[i,]
  covar1 = row.vec[1]
  covar2 = row.vec[2]
  
  print(
    model.df %>%
      drop_na() %>%
      ggplot() +
      geom_point(mapping = aes(x = !!sym(covar.list[covar1]), y = !!sym(covar.list[covar2]), color = wavelength))
  )
  
}
```

```{r}
for (i in c(61:90)) {
  row.vec = covar.combinations[i,]
  covar1 = row.vec[1]
  covar2 = row.vec[2]
  
  print(
    model.df %>%
      drop_na() %>%
      ggplot() +
      geom_point(mapping = aes(x = !!sym(covar.list[covar1]), y = !!sym(covar.list[covar2]), color = wavelength))
  )
}
```


```{r}
for (i in c(91:120)) {
  row.vec = covar.combinations[i,]
  covar1 = row.vec[1]
  covar2 = row.vec[2]
  
  print(
    model.df %>%
      drop_na() %>%
      ggplot() +
      geom_point(mapping = aes(x = !!sym(covar.list[covar1]), y = !!sym(covar.list[covar2]), color = wavelength))
  )
}
```


```{r}
for (i in c(121:136)) {
  row.vec = covar.combinations[i,]
  covar1 = row.vec[1]
  covar2 = row.vec[2]
  
  print(
    model.df %>%
      drop_na() %>%
      ggplot() +
      geom_point(mapping = aes(x = !!sym(covar.list[covar1]), y = !!sym(covar.list[covar2]), color = wavelength))
  )
}
```


## Single pairs plot

depth + width

```{r}
model.df %>%
  filter(wavelength<8600) %>%
  ggplot() +
  geom_point(mapping = aes(x = depth1_center, y = width1_center, color = wavelength),alpha = .2)
```
```{r}
model.df %>%
  filter(wavelength > 8600) %>%
  ggplot() +
  geom_point(mapping = aes(x = depth1_center, y = width1_center, color = wavelength), alpha = .2)
```


```{r}
model.df %>%
  filter(wavelength<8600) %>%
  ggplot() +
  geom_point(mapping = aes(x = depth1, y = width1, color = wavelength))
```


```{r}
model.df %>%
  #filter(wavelength < 7000) %>%
  ggplot() +
  geom_point(mapping = aes(x = depth1, y = width1, color = lambda)) +
  theme(legend.position = "none")
```

```{r}
rm(covar.combinations, covar.list, covar1, covar2, i, row.vec)
```

# rv over time


mean change in rv over time:
```{r}
model.df %>%
  group_by(obs_date) %>%
  summarize( mean_rv_center = mean(rv_center), sd_rv_center = sd(rv_center) ) %>%
  ungroup() %>%
  mutate(date = as.Date(obs_date)) %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = mean_rv_center))
```
mean change in rv over time 95% confidence bars:
```{r}
model.df %>%
  group_by(obs_date) %>%
  summarize( mean_rv_center = mean(rv_center), sd_rv_center = sd(rv_center)/sqrt(309) ) %>%
  ungroup() %>%
  mutate(date = as.Date(obs_date)) %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = mean_rv_center)) +
  geom_errorbar(aes(x = date, ymin = mean_rv_center - 1.96*sd_rv_center, ymax = mean_rv_center + 1.96*sd_rv_center), color = "black")
```

mean change in rv over time, with perturbation:
```{r}
# amplitude
amp = 2
# frequency
freq = 1/30
```

```{r}
# create perturbed df where each day is perturbed by a sinusodial wave
# date_num is the obsdate converted to a numerical and divided to decrease freq of perturbation
# sin_date is 1 times the sin of date_num
model.df %>%
  group_by(obs_date) %>%
  mutate(date_num = as.numeric(as.Date(obs_date)),
         pert_val = amp*sin(freq*date_num)) %>%
  ungroup() %>%
  mutate(rv_pert_center = rv_center + pert_val) %>%
  group_by(obs_date) %>%
  summarize( mean_rv_center = mean(rv_pert_center), sd_rv_center = sd(rv_pert_center) ) %>%
  ungroup() %>%
  mutate(date = as.Date(obs_date)) %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = mean_rv_center))
```

```{r}
# create perturbed df where each day is perturbed by a sinusodial wave
# date_num is the obsdate converted to a numerical and divided to decrease freq of perturbation
# sin_date is 1 times the sin of date_num
model.df %>%
  group_by(obs_date) %>%
  mutate(date_num = as.numeric(as.Date(obs_date)),
         pert_val = amp*sin(freq*date_num)) %>%
  ungroup() %>%
  mutate(rv_pert_center = rv_center + pert_val) %>%
  group_by(obs_date) %>%
  summarize( mean_rv_center = mean(rv_pert_center), sd_rv_center = sd(rv_pert_center)/sqrt(309) ) %>%
  ungroup() %>%
  mutate(date = as.Date(obs_date)) %>%
  ggplot() +
  geom_point(mapping = aes(x = date, y = mean_rv_center)) +
  geom_errorbar(aes(x = date, ymin = mean_rv_center - 1.96*sd_rv_center, ymax = mean_rv_center + 1.96*sd_rv_center), color = "black")
```



```{r}
rm(amp, freq)
```




# Density plot for rv

```{r}
ggplot(model.df, aes(rv)) +
  geom_histogram()
```

```{r}
ggplot(model.df, aes(centered_rv)) +
  geom_histogram(bins = 100)
```

```{r}
ggplot(model.df, aes(scale_rv)) +
  geom_histogram(bins = 100)
```

# hg1 and rv plots

measured hg1 and rv (not centered by line)
```{r}
model.df %>%
  #filter(wavelength<8600) %>%
  ggplot(mapping = aes(x=hg_1, y=rv, color = wavelength)) +
  geom_point(alpha=.2)
```
measured hg1 and rv (centered by line)
```{r}
model.df %>%
  #filter(wavelength<8600) %>%
  ggplot(mapping = aes(x=hg_1_center, y=rv_center, color = wavelength)) +
  geom_point(alpha=.2)
```
measured hg1 and rv (centered by line, high wavelengths removed)
```{r}
model.df %>%
  filter(wavelength<8600) %>%
  ggplot(mapping = aes(x=hg_1_center, y=rv_center, color = wavelength)) +
  geom_point(alpha=.2) +
  xlim(-.005,.005)
```
*possible outlier for hg_1_center*
```{r}
model.df %>% filter(wavelength<8600) %>% filter(hg_1_center > .004)
```

fitting individual lm's on specific lines hg1 v rv
```{r}
i = 301

hg1.lm = lm(rv_center ~ hg_1_center, model.df %>% filter(lam_order == final_lams_orders[i] ) )
model.df %>%
  filter(lam_order == final_lams_orders[i] ) %>%
  ggplot(mapping = aes(x=hg_1_center, y=rv_center)) +
  geom_point() +
  ggtitle( final_lams_orders[i], subtitle = paste0("slope == ",hg1.lm$coefficients[2], ", adj.r.squared == ", summary(hg1.lm)$adj.r.squared) ) +
  geom_smooth(method = "lm", se=F)
```


```{r}
i = 150

hg1.lm = lm(rv_center ~ hg_1_center, model.df %>% filter(lam_order == final_lams_orders[i] ) )
model.df %>%
  filter(lam_order == final_lams_orders[i] ) %>%
  ggplot(mapping = aes(x=hg_1_center, y=rv_center)) +
  geom_point() +
  ggtitle( final_lams_orders[i], subtitle = paste0("slope == ",hg1.lm$coefficients[2], ", adj.r.squared == ", summary(hg1.lm)$adj.r.squared) ) +
  geom_smooth(method = "lm", se=F)
```

```{r}
rm(hg1.lm, hg2.lm, i)
```


# scatter plots depth for two lines + correlation

```{r}
lam1 = "5298.152_58"
lam2 = final_lams_orders[2]

df = model.df %>%
  filter( lam_order == lam1 | lam_order == lam2 ) %>%
  pivot_wider(id_cols = "obs_date", names_from = "lam_order", values_from = "depth1", names_prefix = "depth_")

df %>% ggplot(mapping = aes(x = !!sym( str_c("depth_",lam1) ), y = !!sym( str_c("depth_",lam2) ) ) ) +
  geom_point()

print( cor( df %>% dplyr::select(!(obs_date)), method = "pearson" )[1,2] )
print( cor( df %>% dplyr::select(!(obs_date)), method = "spearman")[1,2] )
```

```{r}
model.df %>%
  mutate(obs_date = as.Date(obs_date)) %>%
  filter( lam_order == lam1 | lam_order == final_lams_orders[2] | lam_order == "5248.496_57" | lam_order == final_lams_orders[120]) %>%
  group_by(lam_order) %>%
  mutate(mean_depth = mean(depth1), sd_depth = sd(depth1)) %>%
  ungroup() %>%
  mutate(std_depth = (depth1 - mean_depth)/sd_depth  ) %>%
  ggplot(mapping = aes(x = obs_date, y = std_depth, color = lam_order)) +
  geom_point()
```

```{r}
lam1 = "9212.524_107"
lam2 = "9572.503_110"

df = model.df %>%
  filter( lam_order == lam1 | lam_order == lam2 ) %>%
  pivot_wider(id_cols = "obs_date", names_from = "lam_order", values_from = "depth1", names_prefix = "depth_")

df %>% ggplot(mapping = aes(x = !!sym( str_c("depth_",lam1) ), y = !!sym( str_c("depth_",lam2) ) ) ) +
  geom_point()

print( cor( df %>% dplyr::select(!(obs_date)), method = "pearson" )[1,2] )
print( cor( df %>% dplyr::select(!(obs_date)), method = "spearman")[1,2] )
```

```{r}
model.df %>%
  mutate(obs_date = as.Date(obs_date)) %>%
  filter( lam_order == lam1 | lam_order == lam2 |lam_order == "9292.992_108" ) %>%
  group_by(lam_order) %>%
  mutate(mean_depth = mean(depth1), sd_depth = sd(depth1)) %>%
  ungroup() %>%
  mutate(std_depth = (depth1 - mean_depth)/sd_depth  ) %>%
  ggplot(mapping = aes(x = obs_date, y = std_depth, color = lam_order)) +
  geom_point()
```

```{r}
rm(lam1,lam2,df)
```


# deviation from mean rv scatter plots

RV deviations
```{r}
# get deviation from mean rv for each line that appears on two orders
dev.df = model.df %>%
  # this line had problematic measurements for one of its orders, so remove it
  filter(lambda != 4662.822) %>%
  filter(repeat_order == T) %>%
  group_by( lambda ) %>%
  mutate( mean_rv = mean(rv) ) %>%
  ungroup() %>%
  mutate(dev_rv = rv - mean_rv)
```

```{r}
# list of repeated lambdas in dev.df
rep_lams = ( dev.df %>% group_by(lambda) %>% summarize(n. = n()) )$lambda
```

```{r}
# pivot the dev.df dataframe to include lambda-obs_date rows with columns for 1st and 2nd order rv observations
dev.df = dev.df %>%
    dplyr::select(lambda,order_idx,obs_date,dev_rv) %>%
    group_by(lambda) %>%
    mutate(order_num = as.factor( ifelse(as.numeric(order_idx) == min(as.numeric(order_idx)), "order_1", "order_2") ) ) %>%
    ungroup() %>%
    dplyr::select(lambda,order_num, obs_date, dev_rv)  %>%
    pivot_wider(names_from = order_num, values_from = dev_rv)
dev.df
```


```{r}
# sequence from 1-length(rep_lams) by 9, for plotting facets
seq_rep_lam = seq(1,length(rep_lams)+9,9)


# begin for loop over every index of above sequence (expect the last one)
for ( i in c( 1:(length(seq_rep_lam)-1)  )  ) {
  # filter every 9 lambdas in rep_lams and print order_2 v. order_1 as a facet
  print(
    dev.df %>%
      filter(lambda %in% rep_lams[seq_rep_lam[i]:(seq_rep_lam[i+1]-1)]) %>%
      ggplot(mapping = aes(x=order_1, y=order_2)) + 
      geom_point() +
      facet_wrap(~ lambda, scales = "free")
  )
}
```

Single lines:


```{r}
dev.df %>%
  filter(lambda == "4182.925") %>%
  ggplot(mapping = aes(x=order_1, y=order_2)) +
  geom_point() +
  ggtitle("4182.925")
```


```{r}
dev.df %>%
  filter(lambda == "5218.829") %>%
  ggplot(mapping = aes(x=order_1, y=order_2)) +
  geom_point() +
  ggtitle("5218.829")
```

```{r}
dev.df %>%
  filter(lambda == "6167.045") %>%
  ggplot(mapping = aes(x=order_1, y=order_2)) +
  geom_point() +
  ggtitle("6167.045")
```

```{r}
rm(dev.df, rep_lams, seq_rep_lam, i)
```


# avg snr by observation date

```{r}
model.df %>%
  group_by(obs_date) %>%
  summarize(avg_snr = mean(snr)) %>%
  mutate(obs_date = as.Date(obs_date)) %>%
  ggplot(mapping = aes(x = obs_date, y = avg_snr)) +
  geom_point()
```


# b1 measurements




```{r}
summary(model.df$b1)
```

density of b1

```{r}
ggplot(model.df, aes(b1)) +
  geom_density()
```

```{r}
model.df %>%
  group_by(obs_date) %>%
  summarize(avg_b1 = mean(b1)) %>%
  mutate(obs_date = as.Date(obs_date)) %>%
  ggplot(mapping = aes(x = obs_date, y = avg_b1)) +
  geom_point()
```

# a1 (slope) measurements

quantiles of a1

```{r}
summary(model.df$a1)
```

density of a1

```{r}
ggplot(model.df, aes(a1)) +
  geom_density()
```

avg a1 by observation date

```{r}
model.df %>%
  group_by(obs_date) %>%
  summarize(avg_a1 = mean(a1)) %>%
  mutate(obs_date = as.Date(obs_date)) %>%
  ggplot(mapping = aes(x = obs_date, y = avg_a1)) +
  geom_point()
```


# rv by b1

```{r}
#png(filename="rv_b1.png")
model.df %>%
  ggplot(mapping = aes(x = b1, y = rv, color = lambda)) +
  geom_point()

#dev.off()
```


*b1 and lambda non singularity issue*

```{r}
model.df %>%
  filter(lambda==final.lams[77] | lambda==final.lams[23]) %>%
  dplyr::select(lambda, a1, b1)
```

b1 over time for various lines

```{r, fig.width = 6, fig.height = 3}
k = 1

plot1 = model.df %>%
  filter(lambda==final.lams[k]) %>%
  ggplot(mapping = aes(x = obs_date, y = b1, color = factor(order_idx))) +
  ggtitle(final.lams[k]) +
  geom_point()


plot2 = model.df %>%
  filter(lambda==final.lams[k]) %>%
  ggplot(mapping = aes(x = obs_date, y = rv, color = factor(order_idx))) +
  ggtitle(final.lams[k]) +
  geom_point()

#png(filename="samp1.png", width=1000, height=500)
#grid.arrange(plot1, plot2, ncol=2)
#dev.off()

grid.arrange(plot1, plot2, ncol=2)
```

```{r, fig.width = 6, fig.height = 3}
k = 10

plot1 = model.df %>%
  filter(lambda==final.lams[k]) %>%
  ggplot(mapping = aes(x = obs_date, y = b1, color = factor(order_idx))) +
  ggtitle(final.lams[k]) +
  geom_point()


plot2 = model.df %>%
  filter(lambda==final.lams[k]) %>%
  ggplot(mapping = aes(x = obs_date, y = rv, color = factor(order_idx))) +
  ggtitle(final.lams[k]) +
  geom_point()

# png(filename="samp2.png", width=1000, height=500)
# grid.arrange(plot1, plot2, ncol=2)
# dev.off()

grid.arrange(plot1, plot2, ncol=2)
```

```{r, fig.width = 6, fig.height = 3}
k = 50

plot1 = model.df %>%
  filter(lambda==final.lams[k]) %>%
  ggplot(mapping = aes(x = obs_date, y = b1, color = factor(order_idx))) +
  ggtitle(final.lams[k]) +
  geom_point()


plot2 = model.df %>%
  filter(lambda==final.lams[k]) %>%
  ggplot(mapping = aes(x = obs_date, y = rv, color = factor(order_idx))) +
  ggtitle(final.lams[k]) +
  geom_point()

# png(filename="samp3.png", width=1000, height=500)
# grid.arrange(plot1, plot2, ncol=2)
# dev.off()

grid.arrange(plot1, plot2, ncol=2)
```


```{r, fig.width = 6, fig.height = 3}
k = 100

plot1 = model.df %>%
  filter(lambda==final.lams[k]) %>%
  ggplot(mapping = aes(x = obs_date, y = b1, color = factor(order_idx))) +
  ggtitle(final.lams[k]) +
  geom_point()


plot2 = model.df %>%
  filter(lambda==final.lams[k]) %>%
  ggplot(mapping = aes(x = obs_date, y = rv, color = factor(order_idx))) +
  ggtitle(final.lams[k]) +
  geom_point()

# png(filename="samp4.png", width=1000, height=500)
# grid.arrange(plot1, plot2, ncol=2)
# dev.off()

grid.arrange(plot1, plot2, ncol=2)
```


```{r, fig.width = 6, fig.height = 3}
k = 150

plot1 = model.df %>%
  filter(lambda==final.lams[k]) %>%
  ggplot(mapping = aes(x = obs_date, y = b1, color = factor(order_idx))) +
  ggtitle(final.lams[k]) +
  geom_point()


plot2 = model.df %>%
  filter(lambda==final.lams[k]) %>%
  ggplot(mapping = aes(x = obs_date, y = rv, color = factor(order_idx))) +
  ggtitle(final.lams[k]) +
  geom_point()

# png(filename="samp5.png", width=1000, height=500)
# grid.arrange(plot1, plot2, ncol=2)
# dev.off()

grid.arrange(plot1, plot2, ncol=2)
```


```{r, fig.width = 6, fig.height = 3}
k = 240

plot1 = model.df %>%
  filter(lambda==final.lams[k]) %>%
  ggplot(mapping = aes(x = obs_date, y = b1, color = factor(order_idx))) +
  ggtitle(final.lams[k]) +
  geom_point()


plot2 = model.df %>%
  filter(lambda==final.lams[k]) %>%
  ggplot(mapping = aes(x = obs_date, y = rv, color = factor(order_idx))) +
  ggtitle(final.lams[k]) +
  geom_point()

# png(filename="samp6.png", width=1000, height=500)
# grid.arrange(plot1, plot2, ncol=2)
# dev.off()

grid.arrange(plot1, plot2, ncol=2)
```

# variance over orders and over time for repeated measurements

RV for a specific line by observation date

```{r}
k = 11

df1 = model.df %>%
  filter(lambda==final.lams[k]) %>%
  dplyr::select(order_idx,obs_date,rv) %>%
  mutate(order_idx = factor(order_idx))
df1
```

```{r}
df1 %>%
  ggplot(mapping = aes(x = obs_date, y = rv, color = factor(order_idx) ) ) +
  geom_point() +
  ggtitle(final.lams[k])
```

```{r}
res.aov = aov(rv ~ factor(obs_date) + order_idx, data = df1)
summary(res.aov)
```
Between Group Variation: The total variation between each group mean and the overall mean.
Within-Group Variation: The total variation in the individual values in each group and their group mean.

F values are ratios of (between group var)/(within group var), MS values are the between group variation

```{r}
# variance across time pooled over order
df1 %>%
  group_by(order_idx) %>%
  summarize(v = var(rv)) %>%
  summarize(pooled_sd_order = sqrt(sum(v)/2))
```

```{r}
# variance across order pooled over time
df1 %>%
  group_by(obs_date) %>%
  summarize(v = var(rv)) %>%
  summarize(pooled_sd_time = sqrt(sum(v)/147))
```

RV's for each line over time and over order

```{r}
# calculate variance across time pooled over order
sd_order = model.df %>%
  filter(repeat_order == T) %>%
  dplyr::select(lambda, order_idx, obs_date, rv) %>%
  group_by(lambda, order_idx) %>%
  summarize(rv_var = var(rv)) %>%
  ungroup() %>%
  group_by(lambda) %>%
  summarize(empiricalRV_var_order = sqrt(sum(rv_var)/2))
sd_order
```

```{r}
# calculate variance across order pooled over time
sd_time = model.df %>%
  filter(repeat_order == T) %>%
  dplyr::select(lambda, order_idx, obs_date, rv) %>%
  group_by(lambda, obs_date) %>%
  summarize(rv_var = var(rv)) %>%
  ungroup() %>%
  group_by(lambda) %>%
  summarize( empiricalRV_var_time = sqrt(sum(rv_var)/147) )
sd_time
```

```{r}
var_final = sd_order %>%
  left_join(sd_time, by = "lambda")
var_final 
```


```{r}
var_final %>%
  ggplot(mapping = aes(x = empiricalRV_var_order, y = empiricalRV_var_time, color = lambda)) +
  geom_point() + 
  geom_abline(slope=1,intercept=0,linetype = 2)
```

# difference across orders helper function

```{r}
# helper "difference" function
diff = function(x) { abs(x[2] - x[1]) }
```


```{r}
model.df %>%
  filter(repeat_order == T) %>%
  dplyr::select(lambda, order_idx, obs_date, rv) %>%
  group_by(lambda, obs_date) %>%
  mutate( diff_rv = diff(rv) ) %>%
  ungroup() %>%
  unique()
```



